<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Â¡A preparar las mochilas!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .item-utiles { transition: transform 0.2s ease-in-out; }
        .item-utiles:hover { transform: scale(1.1); }
        .dragging { opacity: 0.5; cursor: grabbing; transform: scale(1.1); }
        .drop-zone { border: 3px dashed #cbd5e1; transition: background-color 0.3s, border-color 0.3s; }
        .drag-over { background-color: #dbeafe; border-color: #3b82f6; }
        .feedback { transition: opacity 0.5s; }
        .correct-item { text-decoration: line-through; color: #9ca3af; }
        #timer-container { transition: all 0.5s ease-in-out; }
        #send-score-form { transition: all 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #send-score-form.visible { max-height: 500px; opacity: 1; }
    </style>
</head>
<body class="bg-blue-50">
    <div class="container mx-auto p-6 md:p-10">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800 mb-2">ðŸŽ’ Â¡A preparar las mochilas! ðŸŽ’</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <strong>ES:</strong> Eres el padre de una familia numerosa. Â¡Tus 5 hijos necesitan ayuda! Lee la lista de cada uno y arrastra los objetos que faltan a su mochila.
                <br>
                <strong>EN:</strong> You are the parent of a large family. Your 5 children need help! Read each one's list and drag the missing items to their backpack.
            </p>
        </div>

        <!-- Countdown Timer -->
        <div id="timer-container" class="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 rounded-2xl p-4 max-w-md mx-auto mb-8 text-center shadow-lg">
            <div class="flex items-center justify-center">
                <div class="text-4xl mr-4">ðŸšŒ</div>
                <div>
                    <h2 class="text-xl font-bold">Â¡Date prisa! El autobÃºs llega en:</h2>
                    <h2 class="text-lg font-semibold">Hurry up! The bus arrives in:</h2>
                    <div id="countdown" class="text-5xl font-bold tracking-wider mt-1">05:00</div>
                </div>
            </div>
        </div>

        <!-- Caja de Ãštiles (Object Bank) -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10 sticky top-4 z-10">
            <h2 class="text-2xl font-bold text-gray-700 text-center mb-4">Caja de Ãštiles / School Supplies</h2>
            <div id="objectBank" class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4 justify-items-center">
                <!-- Los objetos se generarÃ¡n aquÃ­ con JavaScript -->
            </div>
        </div>

        <!-- Zona de las Mochilas -->
        <div id="childrenContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas de los hijos se generarÃ¡n aquÃ­ -->
        </div>

        <!-- Botones de AcciÃ³n y Feedback -->
        <div class="text-center mt-12">
            <button id="checkBtn" onclick="checkAnswers()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                Revisar Mochilas / Check Backpacks
            </button>
            <button onclick="location.reload()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl text-lg ml-4 transition-transform transform hover:scale-105">
                Reiniciar / Restart
            </button>
            <div id="feedback" class="mt-6 text-2xl font-bold opacity-0 feedback"></div>

            <!-- Formulario para enviar puntaje a Google Sheets -->
            <div id="send-score-form" class="max-w-lg mx-auto mt-8 p-6 bg-white rounded-2xl shadow-lg text-left">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Guardar Resultado / Save Result</h3>
                <div class="mb-4">
                    <label for="studentName" class="block text-gray-700 font-semibold mb-2">Tu Nombre / Your Name:</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Escribe tu nombre aquÃ­...">
                </div>
                <div class="text-center">
                    <button id="sendBtn" onclick="sendScoreToGoogleSheet()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                        Guardar Puntaje / Save Score
                    </button>
                    <p id="send-status" class="text-sm mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vocabulary = [
            { id: 'lapiz', name: 'el lÃ¡piz', emoji: 'png/lapiz.png' },
            { id: 'regla', name: 'la regla', emoji: 'png/regla.png' },
            { id: 'libro', name: 'el libro', emoji: 'png/libro.png' },
            { id: 'diccionario', name: 'el diccionario', emoji: 'png/diccionario.png' },
            { id: 'boligrafo', name: 'el bolÃ­grafo', emoji: 'png/boligrafo.png' },
            { id: 'cuaderno', name: 'el cuaderno', emoji: 'png/cuaderno.png' },
            { id: 'tijeras', name: 'las tijeras', emoji: 'png/tijeras.png' },
            { id: 'borrador', name: 'el borrador', emoji: 'png/borrador.png' },
            { id: 'sacapuntas', name: 'el sacapuntas', emoji: 'png/sacapuntas.png' },
            { id: 'goma', name: 'la goma de borrar', emoji: 'png/goma.png' },
        ];

        const childrenNames = ["Ana", "Luis", "SofÃ­a", "Carlos", "Elena"];
        let childrenData = [];
        let timerInterval;
        let finalScore = 0;
        let percentageScore = 0;
        let gameFinished = false;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeActivity() {
            const objectBank = document.getElementById('objectBank');
            const childrenContainer = document.getElementById('childrenContainer');
            
            const usableVocabulary = vocabulary;
            
            usableVocabulary.forEach(item => {
                const div = document.createElement('div');
                div.id = `item-${item.id}`;
                div.dataset.itemId = item.id;
                div.title = item.name;
                div.className = 'item-utiles w-16 h-16 p-1 bg-gray-100 rounded-lg flex items-center justify-center cursor-grab';
                div.draggable = true;
                div.innerHTML = `<div class="text-4xl select-none flex items-center justify-center">${item.emoji}</div>`;
                div.addEventListener('dragstart', onDragStart);
                div.addEventListener('dragend', onDragEnd);
                objectBank.appendChild(div);
            });

            childrenNames.forEach(name => {
                const shuffledVocab = shuffleArray([...usableVocabulary]);
                const missingItemsCount = Math.floor(Math.random() * 4) + 3;
                const missingItems = shuffledVocab.slice(0, missingItemsCount);
                
                childrenData.push({ name: name, required: missingItems.map(item => item.id), found: [] });

                const childCard = document.createElement('div');
                childCard.className = 'bg-white p-6 rounded-2xl shadow-md';
                
                let listItemsHTML = '';
                missingItems.forEach(item => {
                    listItemsHTML += `<li id="req-${name}-${item.id}" class="text-gray-700 transition-colors">${item.name}</li>`;
                });

                childCard.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">Mochila de ${name}</h3>
                    <p class="font-semibold mb-2 text-gray-500">Faltan estos Ãºtiles / Missing items:</p>
                    <ul class="list-disc list-inside mb-4 space-y-1">${listItemsHTML}</ul>
                    <div id="dropzone-${name}" data-child-name="${name}" class="drop-zone min-h-[150px] p-4 rounded-lg bg-gray-50 grid grid-cols-3 gap-2 items-start content-start relative">
                         <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl text-gray-300 opacity-50 select-none pointer-events-none">ðŸŽ’</div>
                    </div>
                `;
                childrenContainer.appendChild(childCard);
            });
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', onDragOver);
                zone.addEventListener('dragleave', onDragLeave);
                zone.addEventListener('drop', onDrop);
            });
            
            startTimer(300);
        }
        
        function startTimer(durationInSeconds) {
            let timer = durationInSeconds;
            const countdownEl = document.getElementById('countdown');
            const timerContainer = document.getElementById('timer-container');

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                let seconds = timer % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                countdownEl.textContent = `${minutes}:${seconds}`;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    countdownEl.textContent = "00:00";
                    checkAnswers();
                } else if (timer < 59) {
                    timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                    timerContainer.classList.add('bg-orange-100', 'border-orange-300', 'text-orange-800');
                }
            }, 1000);
        }

        function onDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            setTimeout(() => event.target.classList.add('dragging'), 0);
        }
        
        function onDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            const itemId = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(itemId);
            const dropZone = event.currentTarget;
            const childName = dropZone.dataset.childName;
            
            dropZone.classList.remove('drag-over');
            
            const child = childrenData.find(c => c.name === childName);
            const droppedItemId = draggedElement.dataset.itemId;

            if (child.required.includes(droppedItemId) && !child.found.includes(droppedItemId)) {
                const clonedElement = draggedElement.cloneNode(true);
                clonedElement.id = `clone-${childName}-${droppedItemId}`;
                clonedElement.draggable = false;
                clonedElement.style.cursor = 'default';
                clonedElement.classList.remove('item-utiles', 'cursor-grab');
                clonedElement.title = '';
                
                dropZone.appendChild(clonedElement);
                child.found.push(droppedItemId);
                document.getElementById(`req-${childName}-${droppedItemId}`).classList.add('correct-item');
            }
        }

        function checkAnswers() {
            if (gameFinished) return;
            gameFinished = true;
            clearInterval(timerInterval);

            let correctItemsCount = 0;
            let totalRequiredItems = 0;
            childrenData.forEach(child => {
                correctItemsCount += child.found.length;
                totalRequiredItems += child.required.length;
            });

            finalScore = correctItemsCount * 10;
            percentageScore = totalRequiredItems > 0 ? Math.round((correctItemsCount / totalRequiredItems) * 100) : 0;
            const emoji = percentageScore >= 70 ? 'ðŸ˜Š' : 'ðŸ˜Ÿ';

            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('opacity-0');
            feedbackEl.style.opacity = 1;
            
            feedbackEl.innerHTML = `<strong>ES:</strong> Â¡Juego terminado!<br><strong>Puntaje: ${finalScore}</strong> (${percentageScore}% de aciertos) ${emoji}<br><br><strong>EN:</strong> Game Over!<br><strong>Score: ${finalScore}</strong> (${percentageScore}% correct) ${emoji}`;
            
            const timerContainer = document.getElementById('timer-container');
            if (percentageScore >= 70) {
                 feedbackEl.classList.add('text-green-600');
                 timerContainer.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else {
                 feedbackEl.classList.add('text-red-600');
                 timerContainer.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            }
            document.querySelector('#timer-container h2:first-of-type').textContent = "Â¡Tiempo finalizado!";
            document.querySelector('#timer-container h2:last-of-type').textContent = "Time's up!";
            
            document.getElementById('send-score-form').classList.add('visible');
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('objectBank').style.pointerEvents = 'none';
            document.getElementById('objectBank').style.opacity = '0.5';
        }

        function sendScoreToGoogleSheet() {
            const studentName = document.getElementById('studentName').value;
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyWKOmqCWN4H_c42I4DnaO2wrjvpjZbgifu41bfyk4UdDvXJpsF1H1DjnQ3tAV2WhWXnQ/exec';
            const sendStatus = document.getElementById('send-status');
            const sendBtn = document.getElementById('sendBtn');

            if (!studentName) {
                alert("Por favor, ingresa tu nombre. / Please enter your name.");
                return;
            }

            sendStatus.textContent = "Enviando... / Sending...";
            sendBtn.disabled = true;

            const formData = new FormData();
            formData.append('name', studentName);
            formData.append('score', finalScore);
            formData.append('percentage', percentageScore);
            
            // We use 'no-cors' mode as a simple way to submit data to a Google Script
            // from a static HTML file without a complex server setup. The browser
            // sends the data but can't read the response, preventing a CORS error.
            // The .catch block often triggers even on success due to an opaque redirect,
            // so we can treat it as a confirmation that the data was sent.
            fetch(scriptURL, { method: 'POST', body: formData, mode: 'no-cors'})
            .then(() => {
                sendStatus.textContent = "Â¡Resultado guardado con Ã©xito! / Result saved successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
            })
            .catch(error => {
                // This is expected behavior with 'no-cors' mode and Google Scripts.
                // We show a success message as the data has been sent.
                sendStatus.textContent = "Â¡Resultado enviado con Ã©xito! / Result sent successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
                console.log('Request sent. This is the expected outcome with no-cors mode.', error);
            });
        }

        document.addEventListener('DOMContentLoaded', initializeActivity);
    </script>
</body>
</html>

