<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <title>Burbujas de Voz MÃºltiple</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --primary-color: #007aff;
            --text-color: #333;
            --text-light-color: #fff;
            --danger-color: #ff3b30;
            --safe-color: #34c759;
            --card-bg: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --blur-amount: 10px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #game-wrapper {
            height: 95vh;
            width: 95vw;
            max-width: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            position: relative;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            overflow: hidden;
        }
        .numero { 
            position: absolute; 
            font-weight: 700; 
            color: var(--text-color); 
            background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
            transition: transform 0.3s ease, background-color 0.5s linear; 
            border: 1px solid rgba(255,255,255,0.8);
        }
        .numero.exploding { animation: explode 0.5s forwards; }
        @keyframes explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        #ui-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.1), transparent);
        }
        
        #voice-input-button {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            border-radius: 50%;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #voice-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        #voice-input-button:disabled {
            cursor: not-allowed;
            background-color: #999;
        }
        #voice-input-button.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 122, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
        }
        
        #ui-bar p {
            margin: 0;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.8;
        }

        #info-bar {
            position: absolute;
            top: 20px;
            width: 100%;
            padding: 0 30px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            text-shadow: 1px 1px 3px rgba(255,255,255,0.5);
        }
        .screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--card-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            color: var(--text-color);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 30px;
            text-align: center;
        }
        #start-screen { display: flex; }
        .screen h2 { font-size: 2.5rem; margin-bottom: 15px; }
        .screen p { font-size: 1.2rem; max-width: 500px; margin-bottom: 25px; }
        .screen button {
            padding: 15px 35px;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            margin-top: 20px;
            background-color: var(--primary-color);
            color: var(--text-light-color);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        .screen button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(0, 122, 255, 0.4); }
        .screen .button-group { display: flex; gap: 20px; }
        .difficulty-selector { margin: 20px 0; }
        .difficulty-selector select { font-size: 1rem; padding: 10px 15px; border-radius: 10px; border: 1px solid #ccc; background-color: #fff; }
        #high-score-display { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        #review-screen-content { display: flex; gap: 30px; width: 100%; max-width: 800px; height: 60%; }
        .review-column { flex: 1; background-color: rgba(255,255,255,0.5); border-radius: 15px; padding: 20px; overflow-y: auto; }
        .review-column h3 { margin-top: 0; padding-bottom: 10px; font-size: 1.5rem; }
        .review-column ul { list-style: none; padding: 0; }
        #review-correct-list li { background: var(--safe-color); color: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; text-align: center; font-weight: 600; }
        #review-incorrect-list li { background: var(--danger-color); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .review-item-number { font-size: 1.5rem; font-weight: 700; }
        .review-item-text { font-style: italic; font-size: 1.1rem; }
        .speak-button { font-size: 1.5rem; background: none; border: none; cursor: pointer; color: white; vertical-align: middle; transition: transform 0.2s; }
        .speak-button:hover { transform: scale(1.2); }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="info-bar">
                <div id="score">Puntos: 0</div>
                <div id="lives">Vidas: 3</div>
            </div>
            <div id="start-screen" class="screen">
                <h2>Burbujas de Voz</h2>
                <p>Observa los nÃºmeros en las burbujas y <b>dilos en voz alta</b> antes de que exploten.</p>
                <div class="difficulty-selector">
                    <label for="difficulty-select">Elige un nivel:</label>
                    <select id="difficulty-select">
                        <option value="a">Nivel A (0-10)</option>
                        <option value="b" selected>Nivel B (0-20)</option>
                        <option value="c">Nivel C (0-30)</option>
                        <option value="d">Nivel D (Decenas)</option>
                    </select>
                </div>
                <div id="high-score-display">RÃ©cord: 0</div>
                <button id="start-button">Empezar a Jugar</button>
            </div>
            <div id="game-over-screen" class="screen">
                <h2>Juego Terminado</h2>
                <p id="final-score"></p>
                <div class="button-group">
                    <button id="review-button">Ver Resultados</button>
                </div>
            </div>
            <div id="review-screen" class="screen">
                <h2>Resultados y PrÃ¡ctica</h2>
                <div id="review-screen-content">
                    <div class="review-column">
                        <h3 style="color: var(--safe-color);">Correctos</h3>
                        <ul id="review-correct-list"></ul>
                    </div>
                    <div class="review-column">
                        <h3 style="color: var(--danger-color);">A Repasar</h3>
                        <ul id="review-incorrect-list"></ul>
                    </div>
                </div>
                <div class="button-group">
                    <button id="restart-from-review-button">Jugar de Nuevo</button>
                    <button id="home-from-review-button">Ir al Inicio</button>
                </div>
            </div>
            
            <div id="ui-bar">
                <button id="voice-input-button" title="Ingresar por voz">ðŸŽ¤</button>
                <p>Presiona para hablar</p>
            </div>
        </div>
    </div>
<script>
    // --- CONFIGURACIÃ“N ---
    const gameContainer = document.getElementById('game-container');
    const scoreEl = document.getElementById('score'), livesEl = document.getElementById('lives');
    const startScreen = document.getElementById('start-screen'), gameOverScreen = document.getElementById('game-over-screen');
    const reviewScreen = document.getElementById('review-screen');
    const startButton = document.getElementById('start-button'), restartButton = document.getElementById('restart-from-review-button');
    const homeButton = document.getElementById('home-from-review-button');
    const reviewButton = document.getElementById('review-button');
    const finalScoreEl = document.getElementById('final-score'), difficultySelect = document.getElementById('difficulty-select');
    const highScoreDisplay = document.getElementById('high-score-display');
    const voiceInputButton = document.getElementById('voice-input-button');
    const reviewCorrectList = document.getElementById('review-correct-list'), reviewIncorrectList = document.getElementById('review-incorrect-list');

    const popSound = new Audio('https://s3.amazonaws.com/freecodecamp/drums/RP4_KICK_1.mp3');
    const explodeSound = new Audio('https://s3.amazonaws.com/freecodecamp/drums/punchy_kick_1.mp3');
    popSound.volume = 0.5;
    const backgroundMusic = new Audio('https://ianertson.com/apps/breakout/sounds/music.mp3');
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.2;

    let score = 0, lives = 3, gameIsRunning = false;
    let numbersOnScreen = [], spawnInterval;
    let correctNumbersThisRound = [], incorrectNumbersThisRound = [];
    let spawnTracker = {};
    const difficultySettings = { a: { min: 0, max: 10 }, b: { min: 0, max: 20 }, c: { min: 0, max: 30 }, d: { type: 'tens', values: [10, 20, 30, 40, 50, 60, 70, 80, 90] } };
    let currentDifficulty = 'b';
    const BUBBLE_COLOR = { r: 255, g: 255, b: 255 }, DANGER_COLOR = { r: 255, g: 59, b: 48 };
    const HIGH_SCORES_KEY = 'burbujasDictadoHighScores';
    let highScores = { a: 0, b: 0, c: 0, d: 0 };
    
    // --- FUNCIONES AUXILIARES ---
    function numberToWords(n){const u=['cero','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'],e=['diez','once','doce','trece','catorce','quince','diecisÃ©is','diecisiete','dieciocho','diecinueve'],d=['','','veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];if(n>=0&&n<10)return u[n];if(n<20)return e[n-10];if(n<30)return n===20?'veinte':'veinti'+u[n%10];if(n<100){const t=Math.floor(n/10),o=n%10;return d[t]+(o>0?' y '+u[o]:'')}return n.toString()}
    function loadHighScores() { const s = localStorage.getItem(HIGH_SCORES_KEY); if (s) { highScores = JSON.parse(s); } updateHighScoreDisplay(); }
    function updateHighScoreDisplay() { const d = difficultySelect.value; highScoreDisplay.textContent = `RÃ©cord: ${highScores[d] || 0}`; }
    function saveHighScore() { if (score > highScores[currentDifficulty]) { highScores[currentDifficulty] = score; localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(highScores)); } }

    // --- LÃ“GICA DE RECONOCIMIENTO DE VOZ ---
    function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceInputButton.style.display = 'none';
            console.warn("La API de Reconocimiento de Voz no es soportada en este navegador.");
            return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'es-MX';
        recognition.continuous = false;
        recognition.interimResults = false;

        voiceInputButton.addEventListener('click', () => {
            if (gameIsRunning) {
                recognition.start();
            }
        });

        recognition.onstart = () => {
            voiceInputButton.classList.add('listening');
            voiceInputButton.disabled = true;
        };
        
        // --- LÃ“GICA MODIFICADA PARA ACEPTAR MÃšLTIPLES NÃšMEROS ---
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase();
            
            // Itera sobre una copia de las burbujas en pantalla
            [...numbersOnScreen].forEach(num => {
                if (num.saved) return; // Si ya fue acertada, la ignora

                const numAsWord = numberToWords(num.value);
                
                // Si la transcripciÃ³n de la voz incluye el nombre del nÃºmero, se considera un acierto
                if (transcript.includes(numAsWord)) {
                    saveNumber(num);
                }
            });
        };

        recognition.onerror = (event) => {
            console.error("Error en el reconocimiento de voz:", event.error);
            alert("Hubo un error con el micrÃ³fono. AsegÃºrate de darle permiso.");
        };

        recognition.onend = () => {
            voiceInputButton.classList.remove('listening');
            voiceInputButton.disabled = false;
        };
    }

    // --- LÃ“GICA PRINCIPAL DEL JUEGO ---
    function startGame() {
        score = 0; lives = 3; numbersOnScreen = [];
        correctNumbersThisRound = []; incorrectNumbersThisRound = [];
        spawnTracker = {};
        currentDifficulty = difficultySelect.value;
        updateUI();
        startScreen.style.display = 'none'; gameOverScreen.style.display = 'none'; reviewScreen.style.display = 'none';
        gameContainer.querySelectorAll('.numero').forEach(n => n.remove());
        gameIsRunning = true;
        backgroundMusic.currentTime = 0;
        backgroundMusic.play();
        spawnInterval = setInterval(spawnNumber, 3500);
        gameLoop();
    }
    function gameOver() {
        gameIsRunning = false;
        clearInterval(spawnInterval);
        saveHighScore();
        finalScoreEl.textContent = `PuntuaciÃ³n Final: ${score}`;
        gameOverScreen.style.display = 'flex';
        backgroundMusic.pause();
    }
    function showReviewScreen() {
        gameOverScreen.style.display = 'none';
        reviewCorrectList.innerHTML = '';
        reviewIncorrectList.innerHTML = '';
        correctNumbersThisRound.sort((a, b) => a - b).forEach(num => { reviewCorrectList.innerHTML += `<li>${num}</li>`; });
        // En la pantalla de revisiÃ³n, sÃ­ leemos el nÃºmero para practicarlo
        incorrectNumbersThisRound.sort((a, b) => a - b).forEach(num => {
            const numAsWord = numberToWords(num);
            reviewIncorrectList.innerHTML += `<li><div class="review-item-number">${num}</div><div class="review-item-text">${numAsWord}</div><button class="speak-button" onclick="speakReview('${numAsWord}')">ðŸ”Š</button></li>`;
        });
        reviewScreen.style.display = 'flex';
    }
    // FunciÃ³n de voz especÃ­fica para la revisiÃ³n, para no interferir con la del juego.
    function speakReview(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-MX';
        utterance.pitch = 1;
        utterance.rate = 1;
        window.speechSynthesis.speak(utterance);
    }
    function gameLoop() {
        if (!gameIsRunning) return;
        numbersOnScreen.forEach((num, index) => {
            if (num.saved) return;
            num.size += num.growthRate;
            const progress = Math.min(1, (num.size - num.startSize) / (num.maxSize - num.startSize));
            const r = BUBBLE_COLOR.r + (DANGER_COLOR.r - BUBBLE_COLOR.r) * progress;
            const g = BUBBLE_COLOR.g + (DANGER_COLOR.g - BUBBLE_COLOR.g) * progress;
            const b = BUBBLE_COLOR.b + (DANGER_COLOR.b - BUBBLE_COLOR.b) * progress;
            num.element.style.backgroundColor = `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
            num.element.style.width = `${num.size}px`; num.element.style.height = `${num.size}px`;
            num.element.style.fontSize = `${num.size / 3}px`;
            if (num.size >= num.maxSize) { explodeNumber(num, index); }
        });
        requestAnimationFrame(gameLoop);
    }
    function spawnNumber() {
        if (!gameIsRunning || numbersOnScreen.length >= 5) return;
        const settings = difficultySettings[currentDifficulty];
        let value, attempts = 0, maxAttempts = 50;
        do {
            if (settings.type === 'tens') {
                value = settings.values[Math.floor(Math.random() * settings.values.length)];
            } else {
                value = Math.floor(Math.random() * (settings.max - settings.min + 1)) + settings.min;
            }
            attempts++;
        } while ((spawnTracker[value] >= 2) && attempts < maxAttempts);
        spawnTracker[value] = (spawnTracker[value] || 0) + 1;
        const element = document.createElement('div');
        element.classList.add('numero');
        element.textContent = value;
        const startSize = 40;
        const numObj = { value, element, size: startSize, startSize, maxSize: 150 + Math.random() * 50, growthRate: 0.075, saved: false };
        const gameRect = gameContainer.getBoundingClientRect();
        numObj.x = Math.random() * (gameRect.width - numObj.maxSize - 20) + 10;
        numObj.y = Math.random() * (gameRect.height - numObj.maxSize - 150) + 20;
        element.style.top = `${numObj.y}px`; element.style.left = `${numObj.x}px`;
        numbersOnScreen.push(numObj);
        gameContainer.appendChild(element);
        // La lÃ­nea que leÃ­a el nÃºmero (speak) se ha eliminado de aquÃ­.
    }
    function saveNumber(num) {
        num.saved = true; score += 10; updateUI();
        popSound.currentTime = 0; popSound.play();
        correctNumbersThisRound.push(num.value);
        setTimeout(() => { num.element.remove(); numbersOnScreen = numbersOnScreen.filter(n => n !== num); }, 500);
    }
    function explodeNumber(num, index) {
        lives--; updateUI();
        explodeSound.currentTime = 0; explodeSound.play();
        incorrectNumbersThisRound.push(num.value);
        num.element.classList.add('exploding');
        setTimeout(() => { num.element.remove(); }, 500);
        numbersOnScreen.splice(index, 1);
        if (lives <= 0) { gameOver(); }
    }
    function updateUI() { scoreEl.textContent = `Puntos: ${score}`; livesEl.textContent = `Vidas: ${lives}`; }

    // --- EVENT LISTENERS ---
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);
    reviewButton.addEventListener('click', showReviewScreen);
    homeButton.addEventListener('click', () => {
        reviewScreen.style.display = 'none';
        startScreen.style.display = 'flex';
        backgroundMusic.pause();
    });
    difficultySelect.addEventListener('change', updateHighScoreDisplay);
    document.addEventListener('DOMContentLoaded', () => {
        loadHighScores();
        setupSpeechRecognition();
    });
</script>
</body>
</html>
