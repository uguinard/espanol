<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sergio's Sale</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --bg-start: #eef2ff;
        --bg-end: #fdf2f8;
        --text: #0f172a;
        --muted: #475569;
        --accent: #2563eb;
        --accent-soft: rgba(37, 99, 235, 0.12);
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-border: rgba(148, 163, 184, 0.4);
        --shadow: 0 20px 40px -24px rgba(15, 23, 42, 0.65);
      }
      body {
        margin: 0;
        padding: clamp(1.5rem, 4vw, 3rem);
        background: radial-gradient(circle at top, rgba(37, 99, 235, 0.28), transparent 45%),
          radial-gradient(circle at 20% 20%, rgba(236, 72, 153, 0.12), transparent 40%),
          linear-gradient(135deg, var(--bg-start), var(--bg-end));
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
      }
      main {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        margin: 0;
        font-size: clamp(2rem, 4vw, 2.75rem);
      }
      header {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 0.9rem;
      }
      #refreshBtn {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 1.7rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        box-shadow: 0 15px 35px -15px rgba(37, 99, 235, 0.8);
      }
      #refreshBtn:not([disabled]):hover {
        transform: translateY(-1px);
      }
      #refreshBtn[disabled] {
        opacity: 0.5;
        cursor: progress;
      }
      #status {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.9rem;
        background: var(--card-bg);
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow);
      }
      .controls label {
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .controls input,
      .controls select {
        width: 100%;
        margin-top: 0.35rem;
        padding: 0.55rem 0.75rem;
        border-radius: 0.65rem;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(255, 255, 255, 0.85);
        font-size: 0.95rem;
      }
      .inventory-grid {
        margin-top: 2.5rem;
        display: grid;
        gap: 1.5rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 768px) {
        .inventory-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (min-width: 1024px) {
        .inventory-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        will-change: transform, box-shadow;
      }
      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 45px -20px rgba(15, 23, 42, 0.7);
      }
      .card figure {
        margin: 0;
        aspect-ratio: 16 / 9;
        background: #cbd5f5;
        overflow: hidden;
        position: relative;
      }
      .card figure img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .card figure.sold img {
        filter: grayscale(100%);
        opacity: 0.6;
      }
      .card .content {
        padding: 1.2rem 1.4rem 1.35rem;
        flex-grow: 1;
      }
      .card h2 {
        margin: 0 0 0.35rem;
        font-size: 1.2rem;
      }
      .chip {
        display: inline-block;
        border-radius: 999px;
        padding: 0.2rem 0.7rem;
        font-size: 0.85rem;
        margin-right: 0.4rem;
        margin-bottom: 0.4rem;
        background: rgba(37, 99, 235, 0.1);
        color: #1d4ed8;
      }
      .chip.condition-new { background: rgba(22, 163, 74, 0.15); color: #15803d; }
      .chip.condition-used { background: rgba(217, 119, 6, 0.15); color: #b45309; }
      .chip.status-sold { background: rgba(220, 38, 38, 0.15); color: #b91c1c; }
      
      .thumbnail-chip {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: rgba(255, 255, 255, 0.85);
        color: var(--muted);
        padding: 0.3rem 0.65rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.8rem;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0,0,0,0.05);
      }
      .thumbnail-chip.status-sold {
        background: rgba(220, 38, 38, 0.85);
        color: #fff;
      }

      .thumbnail-price-tag {
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        background: rgba(16, 185, 129, 0.9);
        color: #fff;
        padding: 0.3rem 0.65rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.2);
      }

      .price-tag {
        background: rgba(16, 185, 129, 0.17);
        color: #047857;
        padding: 0.2rem 0.55rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.95rem;
      }
      dl {
        margin: 0.75rem 0 0;
      }
      dt {
        font-weight: 600;
        margin-top: 0.85rem;
      }
      dd {
        margin: 0.2rem 0 0.35rem;
        color: var(--muted);
      }
      ul {
        margin: 0.35rem 0;
        padding-left: 1.1rem;
      }
      .price-source {
        border-left: 3px solid rgba(37, 99, 235, 0.3);
        padding-left: 0.5rem;
        margin-top: 0.35rem;
      }
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--muted);
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 1000;
      }
      .modal {
        background: var(--card-bg);
        border-radius: 1.5rem;
        border: 1px solid var(--card-border);
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 1100px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        padding: 2rem;
      }
      .modal-body {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      @media (min-width: 768px) {
        .modal-body {
          grid-template-columns: 3fr 2fr;
        }
      }
      .gallery {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .main-photo {
        width: 100%;
        aspect-ratio: 4 / 3;
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
        background: #e2e8f0;
      }
      .main-photo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .photo-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: rgba(255,255,255,0.8);
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        font-size: 1.5rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .photo-nav.prev { left: 0.5rem; }
      .photo-nav.next { right: 0.5rem; }
      .thumbnails {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.5rem;
      }
      .thumbnails img {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 0.5rem;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
      }
      .thumbnails img.active {
        border-color: var(--accent);
      }
      .item-info h1 {
        margin: 0;
        font-size: 1.75rem;
      }
      .item-info .price-tag {
        font-size: 1.2rem;
        margin-top: 0.5rem;
        display: inline-block;
      }
      .buy-button {
        display: inline-block;
        margin-top: 1.25rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        background: #25d366;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: background-color 0.2s;
      }
      .buy-button:hover {
        background: #128c7e;
      }
      .item-info hr {
        border: none; 
        border-top: 1px solid var(--card-border); 
        margin: 1.25rem 0;
      }
      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--accent-soft);
        border: none;
        border-radius: 999px;
        width: 2.5rem;
        height: 2.5rem;
        cursor: pointer;
        font-size: 1.5rem;
        line-height: 1;
        color: var(--accent);
      }
      .modal-photos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .modal-photos img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 0.75rem;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div>
          <h1>Sergio's sale</h1>
          <div id="summary" class="pill">Loading…</div>
        </div>
        <div>
          <div id="status"></div>
        </div>
      </header>

      <section class="controls">
        <label>
          Search
          <input type="search" id="searchInput" placeholder="Name, description, etc." />
        </label>
        <label>
          Category
          <select id="categoryFilter">
            <option value="">All categories</option>
          </select>
        </label>
        <label>
          Status
          <select id="statusFilter">
            <option value="">All statuses</option>
          </select>
        </label>
        <label>
          Condition
          <select id="conditionFilter">
            <option value="">All conditions</option>
          </select>
        </label>
        <label>
          Sort
          <select id="sortSelect">
            <option value="default">Title A → Z</option>
            <option value="featured">Featured</option>
            <option value="priceDesc">Price: high → low</option>
            <option value="priceAsc">Price: low → high</option>
          </select>
        </label>
      </section>

      <section class="inventory-grid" id="inventoryGrid"></section>
    </main>

    <div class="modal-overlay" id="modalOverlay">
      <div class="modal" id="modal">
        <button class="modal-close" id="modalCloseBtn">&times;</button>
        <div id="modalContent"></div>
      </div>
    </div>

    <script>
      const INVENTORY_CSV_URL = 'inventory_export.csv';
      const PHOTOS_CSV_URL = 'photo_paths.csv';

      const statusEl = document.getElementById('status');
      const summaryEl = document.getElementById('summary');
      const inventoryGrid = document.getElementById('inventoryGrid');
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const statusFilter = document.getElementById('statusFilter');
      const conditionFilter = document.getElementById('conditionFilter');
      const sortSelect = document.getElementById('sortSelect');
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      const modalCloseBtn = document.getElementById('modalCloseBtn');

      let inventoryData = [];

      async function loadInventory() {
        setBusy(true, 'Loading inventory data…');
        try {
          const [inventoryResponse, photosResponse] = await Promise.all([
            fetch(INVENTORY_CSV_URL + '?t=' + Date.now()),
            fetch(PHOTOS_CSV_URL + '?t=' + Date.now()),
          ]);

          const inventoryCsvText = await inventoryResponse.text();
          const photosCsvText = await photosResponse.text();

          const inventoryResult = Papa.parse(inventoryCsvText, { header: true, skipEmptyLines: true });
          const photosResult = Papa.parse(photosCsvText, { header: true, skipEmptyLines: true });
          
          const photoMap = new Map();
          photosResult.data.forEach((row) => {
            if (row.ItemID && row.PhotoPaths) {
              photoMap.set(row.ItemID, row.PhotoPaths);
            }
          });

          inventoryData = inventoryResult.data
            .filter((item) => item.id && item.title)
            .map((item) => {
              const itemID = item.id.trim();
              const photoPaths = photoMap.get(itemID);
              const total_quantity = toNumber(item.total_quantity, 1);
              const sold_quantity = toNumber(item.sold_quantity, 0);
              return {
                ...item,
                photos: photoPaths || '', // Overwrite photos property
                total_quantity,
                sold_quantity,
                available_quantity: total_quantity - sold_quantity,
              };
            });

          buildFilterOptions();
          applyFilters();
          setBusy(false, '');
        } catch (err) {
          console.error(err);
          setBusy(false, 'Failed to load data. Check console for details.');
        }
      }

      function buildFilterOptions() {
        fillSelect(categoryFilter, [...new Set(inventoryData.map((item) => item.category).filter(Boolean))]);
        
        // Build status filter with computed statuses
        const statusValues = new Set();
        inventoryData.forEach((item) => {
          const itemStatus = item.status?.toLowerCase();
          if (itemStatus === 'pending-info') {
            statusValues.add('pending-info');
          } else if (itemStatus === 'sold' || item.available_quantity <= 0) {
            statusValues.add('sold');
          } else {
            statusValues.add('available');
          }
        });
        fillSelect(statusFilter, [...statusValues]);
        
        fillSelect(conditionFilter, [...new Set(inventoryData.map((item) => item.condition).filter(Boolean))]);
      }

      function fillSelect(selectEl, values) {
        const selected = selectEl.value;
        selectEl.innerHTML = `<option value="">All</option>`;
        values.sort().forEach((value) => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          if (value === selected) option.selected = true;
          selectEl.appendChild(option);
        });
      }

      function applyFilters() {
        const query = searchInput.value.trim().toLowerCase();
        const category = categoryFilter.value;
        const status = statusFilter.value;
        const condition = conditionFilter.value;
        const sort = sortSelect.value;

        let items = inventoryData.filter((item) => {
          const matchesQuery =
            !query ||
            [item.title, item.description, item.included_items]
              .filter(Boolean)
              .some((field) => field.toLowerCase().includes(query));
          const matchesCategory = !category || item.category === category;
          const matchesCondition = !condition || item.condition === condition;

          let matchesStatus = !status; // if no status filter, matches all
          if (status) {
            const itemStatus = item.status?.toLowerCase();
            if (status === 'sold') {
                matchesStatus = itemStatus === 'sold' || item.available_quantity <= 0;
            } else if (status === 'available') {
                matchesStatus = item.available_quantity > 0 && itemStatus !== 'sold' && itemStatus !== 'pending-info';
            } else {
                matchesStatus = itemStatus === status;
            }
          }

          return matchesQuery && matchesCategory && matchesStatus && matchesCondition;
        });

        items = sortItems(items, sort);

        updateSummary(items);
        renderCards(items);
      }

      function sortItems(items, sortValue) {
        const list = [...items];
        
        const statusOrder = {
          'available': 1,
          'sold': 2,
          'pending-info': 3,
        };

        const getStatusRank = (item) => {
          const itemStatus = item.status?.toLowerCase();
          if (itemStatus === 'pending-info') return statusOrder['pending-info'];
          if (item.available_quantity <= 0 || itemStatus === 'sold') return statusOrder['sold'];
          return statusOrder['available'];
        };

        list.sort((a, b) => {
          const rankA = getStatusRank(a);
          const rankB = getStatusRank(b);

          if (rankA !== rankB) {
            return rankA - rankB;
          }

          // Status is the same, use selected sort as secondary
          if (sortValue === 'priceAsc') {
            return toNumber(a.asking_price_thb) - toNumber(b.asking_price_thb);
          }
          
          if (sortValue === 'priceDesc' || sortValue === 'featured') {
            return toNumber(b.asking_price_thb) - toNumber(a.asking_price_thb);
          }
          
          // Default sort: title
          return a.title.localeCompare(b.title);
        });

        return list;
      }

      function updateSummary(items) {
        if (!items.length) {
          summaryEl.textContent = 'No items match your filters.';
          return;
        }
        
        const available = items.filter(item => {
          const itemStatus = item.status?.toLowerCase();
          return item.available_quantity > 0 && itemStatus !== 'sold' && itemStatus !== 'pending-info';
        }).length;
        
        const sold = items.filter(item => {
          const itemStatus = item.status?.toLowerCase();
          return itemStatus === 'sold' || item.available_quantity <= 0;
        }).length;
        
        const pendingInfo = items.filter(item => {
          const itemStatus = item.status?.toLowerCase();
          return itemStatus === 'pending-info';
        }).length;
        
        summaryEl.textContent = `${items.length} items · ${available} available · ${sold} sold · ${pendingInfo} pending-info`;
      }

      function renderCards(items) {
        inventoryGrid.innerHTML = '';
        if (!items.length) {
          inventoryGrid.innerHTML = '<div class="empty-state">No results. Adjust the filters above.</div>';
          return;
        }

        items.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'card';
          card.addEventListener('click', () => showModal(item));
          const photoSrc = getFirstPhoto(item);
          const isSold = item.status?.toLowerCase() === 'sold' || item.available_quantity <= 0;

          let imageHtml = '';
          if (photoSrc) {
            if (photoSrc.endsWith('.webp')) {
              const fallbackSrc = photoSrc.replace('inventory_optimized', 'inventory').replace('.webp', '.jpg');
              imageHtml = `<picture>
                <source srcset="${escapeHtml(photoSrc)}" type="image/webp">
                <img src="${escapeHtml(fallbackSrc)}" alt="${escapeHtml(item.title)}" loading="lazy" />
              </picture>`;
            } else {
              imageHtml = `<img src="${escapeHtml(photoSrc)}" alt="${escapeHtml(item.title)}" loading="lazy" />`;
            }
          }

          card.innerHTML = `
            <figure class="${isSold ? 'sold' : ''}">
              ${imageHtml}
              ${renderStatusChip(item.status, true)}
              ${
                item.asking_price_thb
                  ? `<div class="thumbnail-price-tag">${Number(item.asking_price_thb).toLocaleString()} THB</div>`
                  : ''
              }
            </figure>
            <div class="content">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;flex-wrap:wrap;">
                <h2>${escapeHtml(item.title)}</h2>
              </div>
              <div>
                <span class="chip">${escapeHtml(item.category || 'uncategorized')}</span>
                ${renderConditionChip(item.condition)}
                ${item.total_quantity > 1 ? `<span class="chip">${item.available_quantity} / ${item.total_quantity} left</span>` : ''}
              </div>
              <dl>
                <dt>Description</dt>
                <dd>${escapeHtml(item.description || '—')}</dd>
                ${
                  item.purchase_location
                    ? `<dt>Purchased At</dt><dd>${escapeHtml(item.purchase_location)}</dd>`
                    : ''
                }
                ${
                  item.included_items
                    ? `<dt>Included items</dt><dd>${renderList(item.included_items)}</dd>`
                    : ''
                }
                ${renderPriceSource(item)}
              </dl>
            </div>
          `;
          inventoryGrid.appendChild(card);
        });
      }

      function showModal(item) {
        const photoList = item.photos.split(',').map(p => p.trim()).filter(Boolean);
        let currentIndex = 0;

        modalContent.innerHTML = `
          <div class="modal-body">
            <div class="gallery">
              <div class="main-photo" id="mainPhotoContainer"></div>
              <div class="thumbnails" id="thumbnailContainer"></div>
            </div>
            <div class="item-info">
              <h1>${escapeHtml(item.title)}</h1>
              ${item.asking_price_thb ? `<div class="price-tag">${Number(item.asking_price_thb).toLocaleString()} THB</div>` : ''}
              ${item.total_quantity > 1 ? `<div><span class="chip">${item.available_quantity} of ${item.total_quantity} available</span></div>` : ''}
              <hr />
              <div>
                <span class="chip">${escapeHtml(item.category || 'uncategorized')}</span>
                ${renderConditionChip(item.condition)}
                ${renderStatusChip(item.status)}
              </div>
              <dl>
                <dt>Description</dt>
                <dd>${escapeHtml(item.description || '—')}</dd>
                ${item.purchase_location ? `<dt>Purchased At</dt><dd>${escapeHtml(item.purchase_location)}</dd>` : ''}
                ${item.purchase_year ? `<dt>Purchase Year</dt><dd>${escapeHtml(item.purchase_year)}</dd>` : ''}
                ${item.included_items ? `<dt>Included items</dt><dd>${renderList(item.included_items)}</dd>` : ''}
                ${renderPriceSource(item)}
              </dl>
              <a href="https://wa.me/34666209033?text=Hi%20Sergio%2C%20I'm%20interested%20in%20buying%20the%20${encodeURIComponent(item.title)}." 
                target="_blank" 
                rel="noopener"
                class="buy-button">
                Buy on WhatsApp
              </a>
            </div>
          </div>
        `;

        const mainPhotoContainer = document.getElementById('mainPhotoContainer');
        const thumbnailContainer = document.getElementById('thumbnailContainer');

        function updateGallery() {
          if (photoList.length === 0) {
            mainPhotoContainer.innerHTML = '<p style="text-align:center; padding: 2rem;">No photo</p>';
            return;
          }

          let mainPhotoImageHtml;
          const mainPhotoSrc = photoList[currentIndex];
          if (mainPhotoSrc.endsWith('.webp')) {
            const fallbackSrc = mainPhotoSrc.replace('inventory_optimized', 'inventory').replace('.webp', '.jpg');
            mainPhotoImageHtml = `<picture>
              <source srcset="${escapeHtml(mainPhotoSrc)}" type="image/webp">
              <img src="${escapeHtml(fallbackSrc)}" alt="Main photo of ${escapeHtml(item.title)}">
            </picture>`;
          } else {
            mainPhotoImageHtml = `<img src="${escapeHtml(mainPhotoSrc)}" alt="Main photo of ${escapeHtml(item.title)}">`;
          }

          // Main Photo
          mainPhotoContainer.innerHTML = `
            <a href="${escapeHtml(mainPhotoSrc)}" target="_blank" rel="noopener" title="View full image">
              ${mainPhotoImageHtml}
            </a>
            ${photoList.length > 1 ? `
              <button class="photo-nav prev">&lt;</button>
              <button class="photo-nav next">&gt;</button>
            ` : ''}
          `;

          // Thumbnails
          thumbnailContainer.innerHTML = photoList.map((photo, index) => {
            let thumbImageHtml;
            if (photo.endsWith('.webp')) {
              const fallbackSrc = photo.replace('inventory_optimized', 'inventory').replace('.webp', '.jpg');
              thumbImageHtml = `<picture>
                <source srcset="${escapeHtml(photo)}" type="image/webp">
                <img src="${escapeHtml(fallbackSrc)}" alt="Thumbnail ${index + 1}" class="${index === currentIndex ? 'active' : ''}" data-index="${index}">
              </picture>`;
            } else {
              thumbImageHtml = `<img src="${escapeHtml(photo)}" alt="Thumbnail ${index + 1}" class="${index === currentIndex ? 'active' : ''}" data-index="${index}">`;
            }
            return thumbImageHtml;
          }).join('');

          // Event Listeners
          thumbnailContainer.querySelectorAll('img').forEach(img => {
            img.addEventListener('click', (e) => {
              currentIndex = parseInt(e.target.dataset.index);
              updateGallery();
            });
          });

          if (photoList.length > 1) {
            mainPhotoContainer.querySelector('.prev').addEventListener('click', () => {
              currentIndex = (currentIndex - 1 + photoList.length) % photoList.length;
              updateGallery();
            });
            mainPhotoContainer.querySelector('.next').addEventListener('click', () => {
              currentIndex = (currentIndex + 1) % photoList.length;
              updateGallery();
            });
          }
        }

        updateGallery();
        modalOverlay.style.display = 'flex';
      }

      function hideModal() {
        modalOverlay.style.display = 'none';
      }

      function renderStatusChip(status, isThumbnail = false) {
        if (!status) return '';
        const cleanStatus = status.trim().toLowerCase();
        let className = isThumbnail ? 'thumbnail-chip' : 'chip';
        if (cleanStatus === 'sold') {
          className += ' status-sold';
        }
        return `<span class="${className}">${escapeHtml(status)}</span>`;
      }

      function renderConditionChip(condition) {
        if (!condition) return '';
        const cleanCondition = condition.trim().toLowerCase();
        let className = 'chip';
        if (cleanCondition.includes('new') || cleanCondition.includes('mint')) {
          className += ' condition-new';
        } else if (cleanCondition.includes('used')) {
          className += ' condition-used';
        }
        return `<span class="${className}">${escapeHtml(condition)}</span>`;
      }

      function renderPriceSource(item) {
        const name = item[`price_source_1_name`];
        const url = item[`price_source_1_url`];
        const price = item[`price_source_1_price_thb`];
        const notes = item[`price_source_1_notes`];
        if (!name && !url && !price) return '';
        
        const priceText = price ? ` &gt; ${Number(price).toLocaleString()} THB` : '';
        const content = `${escapeHtml(name || 'Source')}${priceText}`;
        
        const link = url 
          ? `<a href="${url}" target="_blank" rel="noopener">${content}</a>` 
          : content;

        return `
          <dt>Price source</dt>
          <dd class="price-source">
            ${link}
            ${notes ? `<br /><small>${escapeHtml(notes)}</small>` : ''}
          </dd>
        `;
      }

      function renderList(value, isPhoto = false) {
        const items = value.split(isPhoto ? ',' : '|').map((entry) => entry.trim()).filter(Boolean);
        if (!items.length) return '—';
        if (isPhoto) {
          return `<ul>${items
            .map((path) => `<li><a href="${escapeHtml(path)}" target="_blank" rel="noopener">${escapeHtml(path)}</a></li>`)
            .join('')}</ul>`;
        }
        return `<ul>${items.map((entry) => `<li>${escapeHtml(entry)}</li>`).join('')}</ul>`;
      }

      function getFirstPhoto(item) {
        const photos = item.photos || '';
        const list = photos.split(',').map((entry) => entry.trim()).filter(Boolean);
        if (!list.length) return '';

        const priorityPhoto = list.find((path) => {
          const filename = path.split('/').pop();
          return filename.startsWith('1');
        });

        return priorityPhoto || list[0];
      }

      function getWebpPath(originalPath) {
        if (!originalPath) return '';
        const lastSlash = originalPath.lastIndexOf('/');
        const dirname = originalPath.substring(0, lastSlash);
        const filename = originalPath.substring(lastSlash + 1);
        const lastDot = filename.lastIndexOf('.');
        const base = lastDot === -1 ? filename : filename.substring(0, lastDot);
        
        let optimizedDirname = dirname;
        if (!dirname.includes('inventory_optimized')) {
            optimizedDirname = dirname.replace('inventory', 'inventory_optimized');
        }
        
        return `${optimizedDirname}/${base}.webp`;
      }

      function toNumber(value, fallback = 0) {
        if (value === undefined || value === null || String(value).trim() === '') return fallback;
        const num = Number(value);
        return Number.isFinite(num) ? num : fallback;
      }

      function escapeHtml(str = '') {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function setBusy(state, message) {
        statusEl.textContent = message;
      }

      searchInput.addEventListener('input', () => applyFilters());
      categoryFilter.addEventListener('change', applyFilters);
      statusFilter.addEventListener('change', applyFilters);
      conditionFilter.addEventListener('change', applyFilters);
      sortSelect.addEventListener('change', applyFilters);

      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          hideModal();
        }
      });
      modalCloseBtn.addEventListener('click', hideModal);

      window.addEventListener('DOMContentLoaded', loadInventory);
    </script>
  </body>
</html>