<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: ¡A preparar las mochilas!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .item-utiles { transition: transform 0.2s ease-in-out; }
        .item-utiles:hover { transform: scale(1.1); }
        .dragging { opacity: 0.5; cursor: grabbing; transform: scale(1.1); }
        .drop-zone { border: 3px dashed #cbd5e1; transition: background-color 0.3s, border-color 0.3s; }
        .drag-over { background-color: #dbeafe; border-color: #3b82f6; }
        .feedback { transition: opacity 0.5s; }
        .correct-item { text-decoration: line-through; color: #9ca3af; }
        #timer-container { transition: all 0.5s ease-in-out; }
        #send-score-form { transition: all 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #send-score-form.visible { max-height: 500px; opacity: 1; }
    </style>
</head>
<body class="bg-blue-50">
    <div class="container mx-auto p-6 md:p-10">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800 mb-2">🎒 ¡A preparar las mochilas! 🎒</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <strong>ES:</strong> Eres el padre de una familia numerosa. ¡Tus 5 hijos necesitan ayuda! Lee la lista de cada uno y arrastra los objetos que faltan a su mochila.
                <br>
                <strong>EN:</strong> You are the parent of a large family. Your 5 children need help! Read each one's list and drag the missing items to their backpack.
            </p>
        </div>

        <!-- Countdown Timer -->
        <div id="timer-container" class="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 rounded-2xl p-4 max-w-md mx-auto mb-8 text-center shadow-lg">
            <div class="flex items-center justify-center">
                <div class="text-4xl mr-4">🚌</div>
                <div>
                    <h2 class="text-xl font-bold">¡Date prisa! El autobús llega en:</h2>
                    <h2 class="text-lg font-semibold">Hurry up! The bus arrives in:</h2>
                    <div id="countdown" class="text-5xl font-bold tracking-wider mt-1">05:00</div>
                </div>
            </div>
        </div>

        <!-- Caja de Útiles (Object Bank) -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10 sticky top-4 z-10">
            <h2 class="text-2xl font-bold text-gray-700 text-center mb-4">Caja de Útiles / School Supplies</h2>
            <div id="objectBank" class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4 justify-items-center">
                <!-- Los objetos se generarán aquí con JavaScript -->
            </div>
        </div>

        <!-- Zona de las Mochilas -->
        <div id="childrenContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas de los hijos se generarán aquí -->
        </div>

        <!-- Botones de Acción y Feedback -->
        <div class="text-center mt-12">
            <button id="checkBtn" onclick="checkAnswers()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                Revisar Mochilas / Check Backpacks
            </button>
            <button onclick="location.reload()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl text-lg ml-4 transition-transform transform hover:scale-105">
                Reiniciar / Restart
            </button>
            <div id="feedback" class="mt-6 text-2xl font-bold opacity-0 feedback"></div>

            <!-- Formulario para enviar puntaje a Google Sheets -->
            <div id="send-score-form" class="max-w-lg mx-auto mt-8 p-6 bg-white rounded-2xl shadow-lg text-left">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Guardar Resultado / Save Result</h3>
                <div class="mb-4">
                    <label for="studentName" class="block text-gray-700 font-semibold mb-2">Tu Nombre / Your Name:</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Escribe tu nombre aquí...">
                </div>
                <div class="text-center">
                    <button id="sendBtn" onclick="sendScoreToGoogleSheet()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                        Guardar Puntaje / Save Score
                    </button>
                    <p id="send-status" class="text-sm mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vocabulary = [
            { id: 'lapiz', name: 'el lápiz', emoji: '<svg clip-rule="evenodd" fill-rule="evenodd" height="512" image-rendering="optimizeQuality" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" viewBox="0 0 43.3492 43.3492" width="512" xmlns="http://www.w3.org/2000/svg" aria-labelledby="svg-title"><title id="svg-title">Portaminas</title><g id="portaminas"><g id="componentes_portaminas"><path id="detalle_goma" d="m21.9533 21.7129c-.1604 0-.3129.0634-.4268.1773-.2346.2347-.2347.6179 0 .8536.114.1138.2664.1763.4268.1763.1614 0 .3129-.0624.4268-.1763.2357-.2357.2357-.6189 0-.8536h.0001c-.1139-.1139-.2655-.1773-.4269-.1773zm0 1.9677c-.3644 0-.707-.1416-.9645-.3991-.5318-.5318-.5318-1.3972 0-1.929.2575-.2585.6001-.4001.9645-.4001.3645 0 .7071.1416.9645.4001l.0001-.0001c.5327.5318.5327 1.3974-.0001 1.9291-.2574.2575-.6001.3991-.9645.3991z"/><path id="borde_exterior_goma" d="m6.0883 20.5781c-1.4241 0-2.7629.5545-3.769 1.5616-1.0071 1.0071-1.5617 2.346-1.5617 3.769.0001 1.424.5546 2.7628 1.5617 3.7699 2.0786 2.0786 5.4603 2.0786 7.5379 0 2.0787-2.0785 2.0786-5.4603 0-7.5389-1.006-1.0071-2.3449-1.5616-3.7689-1.5616zm0 11.4188c-1.5596 0-3.1194-.5932-4.3067-1.7805-2.3757-2.3747-2.3757-6.2397 0-8.6144 2.3747-2.3747 6.2386-2.3746 8.6143 0 2.3747 2.3746 2.3747 6.2397 0 8.6144-1.1882 1.1873-2.748 1.7805-4.3076 1.7805z"/><path id="cuerpo_portaminas" d="m11.31 28.6062c-.0931 0-.1853-.0337-.2585-.101-.1545-.1426-.1635-.3832-.0208-.5377.3298-.3555.6417-.7031.9437-1.0398 1.4468-1.6122 2.5895-2.8846 4.0809-3.3877 1.5775-.5338 3.3233-.1129 5.6376 1.3646l17.4575-10.3087c3.0885-2.5331 3.4569-4.1572 3.4332-4.8424l-21.985 10.7879c-.0237.0119-.0495.0209-.0752.0278-.6467.1614-1.3389.3634-2.0717.5783-2.8499.8338-6.0802 1.7795-8.6272.912-.1989-.0683-.305-.2842-.2367-.4832.0674-.1991.2833-.305.4823-.2367 2.3193.7902 5.4267-.1198 8.1687-.9219.725-.213 1.4111-.414 2.0608-.5774l22.3831-10.9831c.1801-.0881.398-.0207.498.1536.0367.0643.3505.6615.0158 1.7448-.4158 1.3438-1.622 2.8401-3.5867 4.4473-.0148.0119-.0307.0228-.0476.0327l-17.6841 10.4443c-.1248.0733-.2813.0694-.4021-.0098-4.6285-3.0323-6.1585-1.328-8.9362 1.7656-.3029.3386-.6169.6882-.9506 1.0487-.0752.0812-.1773.1218-.2792.1218z"/><path id="borde_interior_goma" d="m6.0883 22.9428c-.7595 0-1.5201.2892-2.0984.8675-.5605.5605-.8695 1.3062-.8695 2.0984.0001.7932.309 1.5379.8695 2.0984 1.1566 1.1576 3.0401 1.1576 4.1967 0 1.1567-1.1566 1.1566-3.0391 0-4.1968-.5783-.5783-1.3378-.8675-2.0983-.8675zm0 6.6923c-.9546 0-1.9093-.3634-2.6361-1.0903-.7041-.7041-1.0923-1.6399-1.0923-2.6361.0001-.9953.3882-1.932 1.0923-2.6361 1.4537-1.4537 3.8184-1.4537 5.2721 0l.0001-.0001c1.4537 1.4538 1.4537 3.8196-.0001 5.2723-.7268.7268-1.6814 1.0903-2.636 1.0903z"/><path id="borde_exterior_punta" d="m17.718 31.9295c-1.424 0-2.7619.5546-3.769 1.5617-2.0785 2.0785-2.0786 5.4603 0 7.5389 1.0072 1.007 2.3449 1.5606 3.769 1.5606 1.424 0 2.7628-.5535 3.7699-1.5606 2.0777-2.0786 2.0776-5.4603 0-7.5389-1.007-1.0072-2.346-1.5617-3.7699-1.5617zm0 11.4198c-1.5596 0-3.1194-.5942-4.3067-1.7815-2.3747-2.3747-2.3747-6.2397 0-8.6144 2.3747-2.3746 6.2386-2.3746 8.6143 0 2.3747 2.3747 2.3747 6.2397 0 8.6144-1.1872 1.1873-2.748 1.7815-4.3076 1.7815z"/><path id="clip_y_punta" d="m18.9162 20.9584c-.0653 0-.1318-.0169-.1931-.0525-.1802-.107-.2407-.3397-.1337-.5209l9.8017-16.5989c.0099-.0158.0207-.0317.0336-.0465 1.6072-1.9647 3.1035-3.1718 4.4463-3.5868 1.0844-.3347 1.6815-.0208 1.7459.0159.1743.099.2416.3169.1525.4971l-8.2876 16.891c-.092.1881-.3199.2664-.509.1733-.188-.0921-.2664-.3199-.1733-.509l8.0757-16.4583c-.6814-.0227-2.3054.3407-4.8435 3.4353l-9.7877 16.5741c-.0704.1198-.1971.1862-.3278.1862zm-3.5144 11.4613c-.1031 0-.2051-.0416-.2793-.1218-.1426-.1545-.1337-.3951.0208-.5377.502-.4655.9902-.8744 1.4626-1.2705 2.1261-1.7835 3.5303-2.9609 2.5271-6.0951-.0643-.2001.0466-.4139.2466-.4783.2001-.0644.4139.0465.4773.2466 1.1587 3.6203-.5714 5.0711-2.7618 6.9091-.4654.3901-.9467.7942-1.4359 1.2467-.0732.0673-.1654.101-.2574.101zm6.5258 1.3626c-.1574 0-.306-.1-.3595-.2585-.8298-2.435-.1089-4.9028.5882-7.2893.1704-.5823.3456-1.1834.4902-1.7617.0516-.204.2575-.3278.4615-.2763.204.0505.3278.2575.2762.4605-.1474.5932-.3257 1.2012-.4981 1.7904-.6634 2.2736-1.3507 4.6235-.5981 6.8319.0674.198-.0386.4139-.2376.4822-.0406.0138-.0812.0208-.1228.0208z"/><path id="borde_interior_punta" d="m17.718 34.2943c-.7595 0-1.5191.2891-2.0984.8675-.5605.5614-.8685 1.3061-.8685 2.0983.0001.7932.308 1.5379.8685 2.0984 1.1576 1.1576 3.0401 1.1576 4.1967 0 .5605-.5605.8695-1.3052.8695-2.0984.0001-.7922-.309-1.5369-.8695-2.0983-.5783-.5784-1.3378-.8675-2.0983-.8675zm0 6.6922c-.9546 0-1.9093-.3634-2.6362-1.0903-.704-.7041-1.0912-1.6399-1.0912-2.6361 0-.9952.3872-1.932 1.0912-2.6361 1.4538-1.4537 3.8185-1.4537 5.2722 0h.0001c.7041.7041 1.0922 1.6409 1.0922 2.6361 0 .9962-.3882 1.932-1.0923 2.6361-.7268.7269-1.6815 1.0903-2.636 1.0903z"/></g></g></svg>' },
            { id: 'regla', name: 'la regla', emoji: '📏' },
            { id: 'libro', name: 'el libro', emoji: '📚' },
            { id: 'diccionario', name: 'el diccionario', emoji: '📖' },
            { id: 'boligrafo', name: 'el bolígrafo', emoji: '🖊️' },
            { id: 'cuaderno', name: 'el cuaderno', emoji: '📓' },
            { id: 'tijeras', name: 'las tijeras', emoji: '✂️' },
            { id: 'borrador', name: 'el borrador', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="16" height="8" rx="2" fill="#4A5568"/><rect x="4" y="13" width="16" height="4" rx="1" fill="#E2E8F0"/><path d="M6 8H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/><path d="M6 10H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/></svg>` },
            { id: 'sacapuntas', name: 'el sacapuntas', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 5H15C15.5523 5 16 5.44772 16 6V18C16 18.5523 15.5523 19 15 19H5C4.44772 19 4 18.5523 4 18V6C4 5.44772 4.44772 5 5 5Z" fill="#4A90E2"/><path d="M16 6L20 9V15L16 18V6Z" fill="#3A7BC8"/><circle cx="10" cy="8" r="3" fill="#FFFFFF"/><circle cx="10" cy="8" r="2" fill="#2D3748"/><rect x="5" y="14" width="10" height="2" rx="1" fill="#D1D5DB"/></svg>` },
            { id: 'goma', name: 'la goma de borrar', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5,7 L19,7 L21,12 L7,12 L5,7 Z" fill="#F56565"/><path d="M7,12 L21,12 L19,17 L5,17 L7,12 Z" fill="#4299E1"/><path d="M5,7 L19,7 L21,12 L7,12 L5,7 Z" stroke="#c53030" stroke-width="1.2"/><path d="M7,12 L21,12 L19,17 L5,17 L7,12 Z" stroke="#2c5282" stroke-width="1.2"/></svg>` }
        ];

        const childrenNames = ["Ana", "Luis", "Sofía", "Carlos", "Elena"];
        let childrenData = [];
        let timerInterval;
        let finalScore = 0;
        let percentageScore = 0;
        let gameFinished = false;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeActivity() {
            const objectBank = document.getElementById('objectBank');
            const childrenContainer = document.getElementById('childrenContainer');
            
            const usableVocabulary = vocabulary;
            
            usableVocabulary.forEach(item => {
                const div = document.createElement('div');
                div.id = `item-${item.id}`;
                div.dataset.itemId = item.id;
                div.title = item.name;
                div.className = 'item-utiles w-16 h-16 p-1 bg-gray-100 rounded-lg flex items-center justify-center cursor-grab';
                div.draggable = true;
                div.innerHTML = `<div class="text-4xl select-none flex items-center justify-center">${item.emoji}</div>`;
                div.addEventListener('dragstart', onDragStart);
                div.addEventListener('dragend', onDragEnd);
                objectBank.appendChild(div);
            });

            childrenNames.forEach(name => {
                const shuffledVocab = shuffleArray([...usableVocabulary]);
                const missingItemsCount = Math.floor(Math.random() * 4) + 3;
                const missingItems = shuffledVocab.slice(0, missingItemsCount);
                
                childrenData.push({ name: name, required: missingItems.map(item => item.id), found: [] });

                const childCard = document.createElement('div');
                childCard.className = 'bg-white p-6 rounded-2xl shadow-md';
                
                let listItemsHTML = '';
                missingItems.forEach(item => {
                    listItemsHTML += `<li id="req-${name}-${item.id}" class="text-gray-700 transition-colors">${item.name}</li>`;
                });

                childCard.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">Mochila de ${name}</h3>
                    <p class="font-semibold mb-2 text-gray-500">Faltan estos útiles / Missing items:</p>
                    <ul class="list-disc list-inside mb-4 space-y-1">${listItemsHTML}</ul>
                    <div id="dropzone-${name}" data-child-name="${name}" class="drop-zone min-h-[150px] p-4 rounded-lg bg-gray-50 grid grid-cols-3 gap-2 items-start content-start relative">
                         <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl text-gray-300 opacity-50 select-none pointer-events-none">🎒</div>
                    </div>
                `;
                childrenContainer.appendChild(childCard);
            });
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', onDragOver);
                zone.addEventListener('dragleave', onDragLeave);
                zone.addEventListener('drop', onDrop);
            });
            
            startTimer(300);
        }
        
        function startTimer(durationInSeconds) {
            let timer = durationInSeconds;
            const countdownEl = document.getElementById('countdown');
            const timerContainer = document.getElementById('timer-container');

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                let seconds = timer % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                countdownEl.textContent = `${minutes}:${seconds}`;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    countdownEl.textContent = "00:00";
                    checkAnswers();
                } else if (timer < 59) {
                    timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                    timerContainer.classList.add('bg-orange-100', 'border-orange-300', 'text-orange-800');
                }
            }, 1000);
        }

        function onDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            setTimeout(() => event.target.classList.add('dragging'), 0);
        }
        
        function onDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            const itemId = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(itemId);
            const dropZone = event.currentTarget;
            const childName = dropZone.dataset.childName;
            
            dropZone.classList.remove('drag-over');
            
            const child = childrenData.find(c => c.name === childName);
            const droppedItemId = draggedElement.dataset.itemId;

            if (child.required.includes(droppedItemId) && !child.found.includes(droppedItemId)) {
                const clonedElement = draggedElement.cloneNode(true);
                clonedElement.id = `clone-${childName}-${droppedItemId}`;
                clonedElement.draggable = false;
                clonedElement.style.cursor = 'default';
                clonedElement.classList.remove('item-utiles', 'cursor-grab');
                clonedElement.title = '';
                
                dropZone.appendChild(clonedElement);
                child.found.push(droppedItemId);
                document.getElementById(`req-${childName}-${droppedItemId}`).classList.add('correct-item');
            }
        }

        function checkAnswers() {
            if (gameFinished) return;
            gameFinished = true;
            clearInterval(timerInterval);

            let correctItemsCount = 0;
            let totalRequiredItems = 0;
            childrenData.forEach(child => {
                correctItemsCount += child.found.length;
                totalRequiredItems += child.required.length;
            });

            finalScore = correctItemsCount * 10;
            percentageScore = totalRequiredItems > 0 ? Math.round((correctItemsCount / totalRequiredItems) * 100) : 0;
            const emoji = percentageScore >= 70 ? '😊' : '😟';

            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('opacity-0');
            feedbackEl.style.opacity = 1;
            
            feedbackEl.innerHTML = `<strong>ES:</strong> ¡Juego terminado!<br><strong>Puntaje: ${finalScore}</strong> (${percentageScore}% de aciertos) ${emoji}<br><br><strong>EN:</strong> Game Over!<br><strong>Score: ${finalScore}</strong> (${percentageScore}% correct) ${emoji}`;
            
            const timerContainer = document.getElementById('timer-container');
            if (percentageScore >= 70) {
                 feedbackEl.classList.add('text-green-600');
                 timerContainer.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else {
                 feedbackEl.classList.add('text-red-600');
                 timerContainer.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            }
            document.querySelector('#timer-container h2:first-of-type').textContent = "¡Tiempo finalizado!";
            document.querySelector('#timer-container h2:last-of-type').textContent = "Time's up!";
            
            document.getElementById('send-score-form').classList.add('visible');
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('objectBank').style.pointerEvents = 'none';
            document.getElementById('objectBank').style.opacity = '0.5';
        }

        function sendScoreToGoogleSheet() {
            const studentName = document.getElementById('studentName').value;
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyWKOmqCWN4H_c42I4DnaO2wrjvpjZbgifu41bfyk4UdDvXJpsF1H1DjnQ3tAV2WhWXnQ/exec';
            const sendStatus = document.getElementById('send-status');
            const sendBtn = document.getElementById('sendBtn');

            if (!studentName) {
                alert("Por favor, ingresa tu nombre. / Please enter your name.");
                return;
            }

            sendStatus.textContent = "Enviando... / Sending...";
            sendBtn.disabled = true;

            const formData = new FormData();
            formData.append('name', studentName);
            formData.append('score', finalScore);
            formData.append('percentage', percentageScore);
            
            // We use 'no-cors' mode as a simple way to submit data to a Google Script
            // from a static HTML file without a complex server setup. The browser
            // sends the data but can't read the response, preventing a CORS error.
            // The .catch block often triggers even on success due to an opaque redirect,
            // so we can treat it as a confirmation that the data was sent.
            fetch(scriptURL, { method: 'POST', body: formData, mode: 'no-cors'})
            .then(() => {
                sendStatus.textContent = "¡Resultado guardado con éxito! / Result saved successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
            })
            .catch(error => {
                // This is expected behavior with 'no-cors' mode and Google Scripts.
                // We show a success message as the data has been sent.
                sendStatus.textContent = "¡Resultado enviado con éxito! / Result sent successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
                console.log('Request sent. This is the expected outcome with no-cors mode.', error);
            });
        }

        document.addEventListener('DOMContentLoaded', initializeActivity);
    </script>
</body>
</html>

