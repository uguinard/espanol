<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: ¡A preparar las mochilas!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .item-utiles { transition: transform 0.2s ease-in-out; }
        .item-utiles:hover { transform: scale(1.1); }
        .dragging { opacity: 0.5; cursor: grabbing; transform: scale(1.1); }
        .drop-zone { border: 3px dashed #cbd5e1; transition: background-color 0.3s, border-color 0.3s; }
        .drag-over { background-color: #dbeafe; border-color: #3b82f6; }
        .feedback { transition: opacity 0.5s; }
        .correct-item { text-decoration: line-through; color: #9ca3af; }
        #timer-container { transition: all 0.5s ease-in-out; }
        #send-score-form { transition: all 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #send-score-form.visible { max-height: 500px; opacity: 1; }
    </style>
</head>
<body class="bg-blue-50">
    <div class="container mx-auto p-6 md:p-10">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800 mb-2">🎒 ¡A preparar las mochilas! 🎒</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <strong>ES:</strong> Eres el padre de una familia numerosa. ¡Tus 5 hijos necesitan ayuda! Lee la lista de cada uno y arrastra los objetos que faltan a su mochila.
                <br>
                <strong>EN:</strong> You are the parent of a large family. Your 5 children need help! Read each one's list and drag the missing items to their backpack.
            </p>
        </div>

        <!-- Countdown Timer -->
        <div id="timer-container" class="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 rounded-2xl p-4 max-w-md mx-auto mb-8 text-center shadow-lg">
            <div class="flex items-center justify-center">
                <div class="text-4xl mr-4">🚌</div>
                <div>
                    <h2 class="text-xl font-bold">¡Date prisa! El autobús llega en:</h2>
                    <h2 class="text-lg font-semibold">Hurry up! The bus arrives in:</h2>
                    <div id="countdown" class="text-5xl font-bold tracking-wider mt-1">05:00</div>
                </div>
            </div>
        </div>

        <!-- Caja de Útiles (Object Bank) -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10 sticky top-4 z-10">
            <h2 class="text-2xl font-bold text-gray-700 text-center mb-4">Caja de Útiles / School Supplies</h2>
            <div id="objectBank" class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4 justify-items-center">
                <!-- Los objetos se generarán aquí con JavaScript -->
            </div>
        </div>

        <!-- Zona de las Mochilas -->
        <div id="childrenContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas de los hijos se generarán aquí -->
        </div>

        <!-- Botones de Acción y Feedback -->
        <div class="text-center mt-12">
            <button id="checkBtn" onclick="checkAnswers()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                Revisar Mochilas / Check Backpacks
            </button>
            <button onclick="location.reload()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl text-lg ml-4 transition-transform transform hover:scale-105">
                Reiniciar / Restart
            </button>
            <div id="feedback" class="mt-6 text-2xl font-bold opacity-0 feedback"></div>

            <!-- Formulario para enviar puntaje -->
            <div id="send-score-form" class="max-w-lg mx-auto mt-8 p-6 bg-white rounded-2xl shadow-lg text-left">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Enviar Resultado al Profesor / Send Result to Teacher</h3>
                <div class="mb-4">
                    <label for="studentName" class="block text-gray-700 font-semibold mb-2">Tu Nombre / Your Name:</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Escribe tu nombre aquí...">
                </div>
                <div class="mb-4">
                    <label for="teacherEmail" class="block text-gray-700 font-semibold mb-2">Email del Profesor / Teacher's Email:</label>
                    <input type="email" id="teacherEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="profesor@ejemplo.com">
                </div>
                <div class="text-center">
                    <button onclick="sendScoreToTeacher()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                        Enviar Puntaje / Send Score
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vocabulary = [
            { id: 'lapiz', name: 'el lápiz', emoji: '✏️' },
            { id: 'regla', name: 'la regla', emoji: '📏' },
            { id: 'libro', name: 'el libro', emoji: '📚' },
            { id: 'diccionario', name: 'el diccionario', emoji: '📖' },
            { id: 'boligrafo', name: 'el bolígrafo', emoji: '🖊️' },
            { id: 'cuaderno', name: 'el cuaderno', emoji: '📓' },
            { id: 'tijeras', name: 'las tijeras', emoji: '✂️' },
            // --- Custom SVGs ---
            { id: 'borrador', name: 'el borrador', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="16" height="8" rx="2" fill="#4A5568"/><rect x="4" y="13" width="16" height="4" rx="1" fill="#E2E8F0"/><path d="M6 8H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/><path d="M6 10H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/></svg>` },
            { id: 'sacapuntas', name: 'el sacapuntas', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 5H15C15.5523 5 16 5.44772 16 6V18C16 18.5523 15.5523 19 15 19H5C4.44772 19 4 18.5523 4 18V6C4 5.44772 4.44772 5 5 5Z" fill="#4A90E2"/><path d="M16 6L20 9V15L16 18V6Z" fill="#3A7BC8"/><circle cx="10" cy="8" r="3" fill="#FFFFFF"/><circle cx="10" cy="8" r="2" fill="#2D3748"/><rect x="5" y="14" width="10" height="2" rx="1" fill="#D1D5DB"/></svg>` },
            { id: 'goma', name: 'la goma de borrar', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5,7 L19,7 L21,12 L7,12 L5,7 Z" fill="#F56565"/><path d="M7,12 L21,12 L19,17 L5,17 L7,12 Z" fill="#4299E1"/><path d="M5,7 L19,7 L21,12 L7,12 L5,7 Z" stroke="#c53030" stroke-width="1.2"/><path d="M7,12 L21,12 L19,17 L5,17 L7,12 Z" stroke="#2c5282" stroke-width="1.2"/></svg>` }
        ];

        const childrenNames = ["Ana", "Luis", "Sofía", "Carlos", "Elena"];
        let childrenData = [];
        let timerInterval;
        let finalScore = 0;
        let timeRemaining = 0;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeActivity() {
            const objectBank = document.getElementById('objectBank');
            const childrenContainer = document.getElementById('childrenContainer');
            
            const usableVocabulary = vocabulary;
            
            usableVocabulary.forEach(item => {
                const div = document.createElement('div');
                div.id = `item-${item.id}`;
                div.dataset.itemId = item.id;
                div.title = item.name;
                div.className = 'item-utiles w-16 h-16 p-1 bg-gray-100 rounded-lg flex items-center justify-center cursor-grab';
                div.draggable = true;
                div.innerHTML = `<div class="text-4xl select-none flex items-center justify-center">${item.emoji}</div>`;
                div.addEventListener('dragstart', onDragStart);
                div.addEventListener('dragend', onDragEnd);
                objectBank.appendChild(div);
            });

            childrenNames.forEach(name => {
                const shuffledVocab = shuffleArray([...usableVocabulary]);
                const missingItemsCount = Math.floor(Math.random() * 4) + 3;
                const missingItems = shuffledVocab.slice(0, missingItemsCount);
                
                childrenData.push({ name: name, required: missingItems.map(item => item.id), found: [] });

                const childCard = document.createElement('div');
                childCard.className = 'bg-white p-6 rounded-2xl shadow-md';
                
                let listItemsHTML = '';
                missingItems.forEach(item => {
                    listItemsHTML += `<li id="req-${name}-${item.id}" class="text-gray-700 transition-colors">${item.name}</li>`;
                });

                childCard.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">Mochila de ${name}</h3>
                    <p class="font-semibold mb-2 text-gray-500">Faltan estos útiles / Missing items:</p>
                    <ul class="list-disc list-inside mb-4 space-y-1">${listItemsHTML}</ul>
                    <div id="dropzone-${name}" data-child-name="${name}" class="drop-zone min-h-[150px] p-4 rounded-lg bg-gray-50 grid grid-cols-3 gap-2 items-start content-start relative">
                         <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl text-gray-300 opacity-50 select-none pointer-events-none">🎒</div>
                    </div>
                `;
                childrenContainer.appendChild(childCard);
            });
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', onDragOver);
                zone.addEventListener('dragleave', onDragLeave);
                zone.addEventListener('drop', onDrop);
            });
            
            startTimer(300); // Start 5-minute timer
        }
        
        function startTimer(durationInSeconds) {
            let timer = durationInSeconds;
            timeRemaining = durationInSeconds;
            const countdownEl = document.getElementById('countdown');
            const timerContainer = document.getElementById('timer-container');

            timerInterval = setInterval(() => {
                timeRemaining = timer;
                const minutes = Math.floor(timer / 60);
                let seconds = timer % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                countdownEl.textContent = `${minutes}:${seconds}`;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    countdownEl.textContent = "00:00";
                    timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800', 'bg-orange-100', 'border-orange-300', 'text-orange-800');
                    timerContainer.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
                    document.querySelector('#timer-container h2:first-of-type').textContent = "¡El autobús se ha ido!";
                    document.querySelector('#timer-container h2:last-of-type').textContent = "The bus has left!";
                    document.getElementById('objectBank').style.pointerEvents = 'none';
                    document.getElementById('checkBtn').disabled = true;
                    document.getElementById('objectBank').style.opacity = '0.5';
                } else if (timer < 59) {
                    timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                    timerContainer.classList.add('bg-orange-100', 'border-orange-300', 'text-orange-800');
                }
            }, 1000);
        }

        function onDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            setTimeout(() => event.target.classList.add('dragging'), 0);
        }
        
        function onDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            const itemId = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(itemId);
            const dropZone = event.currentTarget;
            const childName = dropZone.dataset.childName;
            
            dropZone.classList.remove('drag-over');
            
            const child = childrenData.find(c => c.name === childName);
            const droppedItemId = draggedElement.dataset.itemId;

            if (child.required.includes(droppedItemId) && !child.found.includes(droppedItemId)) {
                const clonedElement = draggedElement.cloneNode(true);
                clonedElement.id = `clone-${childName}-${droppedItemId}`;
                clonedElement.draggable = false;
                clonedElement.style.cursor = 'default';
                clonedElement.classList.remove('item-utiles', 'cursor-grab');
                clonedElement.title = '';
                
                dropZone.appendChild(clonedElement);
                child.found.push(droppedItemId);
                document.getElementById(`req-${childName}-${droppedItemId}`).classList.add('correct-item');
            }
        }

        function checkAnswers() {
            let allCorrect = true;
            let correctItemsCount = 0;
            childrenData.forEach(child => {
                correctItemsCount += child.found.length;
                if (child.required.length !== child.found.length) {
                    allCorrect = false;
                }
            });

            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('opacity-0', 'text-green-600', 'text-red-600');
            feedbackEl.style.opacity = 1;
            
            if (allCorrect) {
                clearInterval(timerInterval);
                const itemsScore = correctItemsCount * 10;
                const timeBonus = timeRemaining;
                finalScore = itemsScore + timeBonus;

                feedbackEl.innerHTML = `<strong>ES:</strong> ¡Felicidades! Todas las mochilas están listas. ¡Llegaste a tiempo!<br><strong>Puntaje Final: ${finalScore}</strong> (${itemsScore} de objetos + ${timeBonus} de tiempo)<br><br><strong>EN:</strong> Congratulations! All backpacks are ready. You made it on time!<br><strong>Final Score: ${finalScore}</strong> (${itemsScore} from items + ${timeBonus} time bonus)`;
                feedbackEl.classList.add('text-green-600');
                
                const timerContainer = document.getElementById('timer-container');
                timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800', 'bg-orange-100', 'border-orange-300', 'text-orange-800');
                timerContainer.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
                document.querySelector('#timer-container h2:first-of-type').textContent = "¡Llegaste a tiempo!";
                document.querySelector('#timer-container h2:last-of-type').textContent = "You made it on time!";
                
                document.getElementById('send-score-form').classList.add('visible');
                document.getElementById('checkBtn').disabled = true;

            } else {
                feedbackEl.innerHTML = "<strong>ES:</strong> ¡Casi! Revisa las mochilas, parece que todavía faltan algunas cosas.<br><strong>EN:</strong> Almost! Check the backpacks, it looks like some things are still missing.";
                feedbackEl.classList.add('text-red-600');
            }
        }

        function sendScoreToTeacher() {
            const studentName = document.getElementById('studentName').value;
            const teacherEmail = document.getElementById('teacherEmail').value;

            if (!studentName || !teacherEmail) {
                alert("Por favor, ingresa tu nombre y el email de tu profesor. / Please enter your name and your teacher's email.");
                return;
            }

            const subject = encodeURIComponent(`Resultado de la Actividad: Preparar Mochilas de ${studentName}`);
            const body = encodeURIComponent(
                `¡Hola!\n\n` +
                `He completado la actividad "Preparar las Mochilas".\n\n` +
                `Estudiante: ${studentName}\n` +
                `Puntaje Final: ${finalScore}\n` +
                `Tiempo Restante: ${Math.floor(timeRemaining/60)}m ${timeRemaining%60}s\n\n` +
                `Saludos,\n` +
                `${studentName}`
            );

            window.location.href = `mailto:${teacherEmail}?subject=${subject}&body=${body}`;
        }

        document.addEventListener('DOMContentLoaded', initializeActivity);
    </script>
</body>
</html>

