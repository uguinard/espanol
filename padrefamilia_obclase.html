<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Â¡A preparar las mochilas!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .item-utiles { transition: transform 0.2s ease-in-out; }
        .item-utiles:hover { transform: scale(1.1); }
        .dragging { opacity: 0.5; cursor: grabbing; transform: scale(1.1); }
        .drop-zone { border: 3px dashed #cbd5e1; transition: background-color 0.3s, border-color 0.3s; }
        .drag-over { background-color: #dbeafe; border-color: #3b82f6; }
        .feedback { transition: opacity 0.5s; }
        .correct-item { text-decoration: line-through; color: #9ca3af; }
        #timer-container { transition: all 0.5s ease-in-out; }
        #send-score-form { transition: all 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #send-score-form.visible { max-height: 500px; opacity: 1; }
    </style>
</head>
<body class="bg-blue-50">
    <div class="container mx-auto p-6 md:p-10">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800 mb-2">ðŸŽ’ Â¡A preparar las mochilas! ðŸŽ’</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <strong>ES:</strong> Eres el padre de una familia numerosa. Â¡Tus 5 hijos necesitan ayuda! Lee la lista de cada uno y arrastra los objetos que faltan a su mochila.
                <br>
                <strong>EN:</strong> You are the parent of a large family. Your 5 children need help! Read each one's list and drag the missing items to their backpack.
            </p>
        </div>

        <!-- Countdown Timer -->
        <div id="timer-container" class="bg-yellow-100 border-2 border-yellow-300 text-yellow-800 rounded-2xl p-4 max-w-md mx-auto mb-8 text-center shadow-lg">
            <div class="flex items-center justify-center">
                <div class="text-4xl mr-4">ðŸšŒ</div>
                <div>
                    <h2 class="text-xl font-bold">Â¡Date prisa! El autobÃºs llega en:</h2>
                    <h2 class="text-lg font-semibold">Hurry up! The bus arrives in:</h2>
                    <div id="countdown" class="text-5xl font-bold tracking-wider mt-1">05:00</div>
                </div>
            </div>
        </div>

        <!-- Caja de Ãštiles (Object Bank) -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-10 sticky top-4 z-10">
            <h2 class="text-2xl font-bold text-gray-700 text-center mb-4">Caja de Ãštiles / School Supplies</h2>
            <div id="objectBank" class="grid grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4 justify-items-center">
                <!-- Los objetos se generarÃ¡n aquÃ­ con JavaScript -->
            </div>
        </div>

        <!-- Zona de las Mochilas -->
        <div id="childrenContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Las tarjetas de los hijos se generarÃ¡n aquÃ­ -->
        </div>

        <!-- Botones de AcciÃ³n y Feedback -->
        <div class="text-center mt-12">
            <button id="checkBtn" onclick="checkAnswers()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                Revisar Mochilas / Check Backpacks
            </button>
            <button onclick="location.reload()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl text-lg ml-4 transition-transform transform hover:scale-105">
                Reiniciar / Restart
            </button>
            <div id="feedback" class="mt-6 text-2xl font-bold opacity-0 feedback"></div>

            <!-- Formulario para enviar puntaje a Google Sheets -->
            <div id="send-score-form" class="max-w-lg mx-auto mt-8 p-6 bg-white rounded-2xl shadow-lg text-left">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Guardar Resultado / Save Result</h3>
                <div class="mb-4">
                    <label for="studentName" class="block text-gray-700 font-semibold mb-2">Tu Nombre / Your Name:</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Escribe tu nombre aquÃ­...">
                </div>
                <div class="text-center">
                    <button id="sendBtn" onclick="sendScoreToGoogleSheet()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl text-lg transition-transform transform hover:scale-105">
                        Guardar Puntaje / Save Score
                    </button>
                    <p id="send-status" class="text-sm mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vocabulary = [
            { id: 'lapiz', name: 'el lÃ¡piz', emoji: '<svg width="48" height="48"> <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="682.7" height="682.7"><defs><clipPath id="a" clipPathUnits="userSpaceOnUse"><path d="M0 512h512V0H0Z"/></clipPath></defs><g fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="22.9" stroke-width="20" clip-path="url(#a)" transform="matrix(1.33 0 0 -1.33 0 683)"><path d="m429 493 64-64c12-11 12-30 0-42L173 66 10 10l56 163 321 320c12 12 31 12 42 0Z"/><path d="M74 39a59 59 0 0 1-35 35m310 373 98-98m-134 62 98-98M69 172l49-8 1-45 45-1 8-49m167 316L118 164m267 175L164 118"/></g></svg>' },
            { id: 'regla', name: 'la regla', emoji: '<svg width="48" height="48"> <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 423 423"><path d="M417 82 341 6c-8-8-22-8-30 0l-84 83-20 21-21 21L81 236l-21 21-54 54c-8 8-8 21 0 30l76 76c8 8 22 8 30 0l305-305c8-8 8-22 0-30zm-7 23L105 410c-4 4-11 4-16 0l-76-76c-4-5-4-12 0-16l50-50 40 39a5 5 0 1 0 7-7l-39-39 13-14 18 18a5 5 0 1 0 7-8l-18-17 14-14 18 18a5 5 0 0 0 7-8l-18-17 14-14 39 39a5 5 0 0 0 8-7l-40-39 14-14 18 18a5 5 0 1 0 7-7l-18-18 14-14 18 18a5 5 0 0 0 7-7l-18-18 14-14 39 39a5 5 0 0 0 7-7l-39-39 14-14 18 18a5 5 0 1 0 7-7l-18-18 14-14 18 18a5 5 0 0 0 7-7l-18-18 14-14 39 39a5 5 0 0 0 7-7l-39-39 14-14 18 18a5 5 0 0 0 7-7l-18-18 14-14 39 39a5 5 0 0 0 7-7l-39-39 17-17c4-4 11-4 15 0l76 76c5 4 5 11 0 16h1z"/><path d="M91 331zm-7 28a15 15 0 1 1 0-21v1c6 5 6 14 0 20z"/></svg>' },
            { id: 'libro', name: 'el libro', emoji: '<svg width="48" height="48"> <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="682.7" height="682.7" viewBox="0 0 683 683"><defs><clipPath id="a" clipPathUnits="userSpaceOnUse"><path d="M0 512h512V0H0Z"/></clipPath></defs><g fill="none" stroke="#060606" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="15" clip-path="url(#a)" transform="matrix(1.3 0 0 -1.3 0 683)"><path d="M256 346s-12 107-144 159v-42m144-117s12 107 144 159v-42"/><path d="M146 447c-45 24-84 33-84 33l-27-28m223-106c-18 32-44 57-71 76"/><path d="M254 346c58 103 196 134 196 134l27-28M280 8h-48c-5 0-10 4-10 10v318c0 5 5 10 10 10h48c5 0 10-5 10-10V18c0-6-5-10-10-10Z"/><path d="M290 277h-68v34h68zm0-235h-68v34h68zm-34 180v-90m247 42v-41c0-3-2-7-5-8L305 16c-7-4-15 1-15 9v315c0 3 2 7 5 9l193 108c7 4 15-1 15-8V222M207 16 14 125c-3 1-5 5-5 8v316c0 7 8 12 15 8l193-108c3-2 5-6 5-9V25c0-8-8-13-15-9Z"/><path d="m466 326-140-80v49l140 80Z"/></g></svg>' },
            { id: 'diccionario', name: 'el diccionario', emoji: '<svg width="48" height="48"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 64 64"><path d="M16 39a1 1 0 0 0 1-1V12a1 1 0 0 0-2 0v26a1 1 0 0 0 1 1Z"/><path d="M54 2H16a7 7 0 0 0-7 7v43a6 6 0 0 0 6 6h26v3a1 1 0 0 0 .5.9 1 1 0 0 0 1 0l2.5-1.7 2.5 1.6A1 1 0 0 0 49 61v-3h5a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Zm-7 57.1-1.4-1a1 1 0 0 0-1.2 0l-1.4 1V53h4Zm6-3.1h-4v-3h4Zm0-5H20a1 1 0 0 0 0 2h21v3H15a4 4 0 0 1-2.8-6.8A4 4 0 0 1 15 48h38Zm0-5H15a6 6 0 0 0-4 1.5V9a5 5 0 0 1 5-5h37Z"/><path d="M16 51h-2a1 1 0 0 0 0 2h2a1 1 0 0 0 0-2Zm0-42a1 1 0 0 0 1-1V7a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm0 35a1 1 0 0 0 1-1v-1a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm4.6-16a1 1 0 0 0 1.3-.6l1.4-3.4h5.4l1.4 3.4a1 1 0 1 0 1.8-.8l-5-12a1 1 0 0 0-1.8 0l-5 12a1 1 0 0 0 .5 1.3ZM26 17.5l1.8 4.4h-3.6ZM40 16h6.1l-7 10.4A1 1 0 0 0 40 28h8a1 1 0 0 0 0-2h-6.1l7-10.4A1 1 0 0 0 48 14h-8a1 1 0 0 0 0 2Zm-6 6h3a1 1 0 0 0 0-2h-3a1 1 0 0 0 0 2Z"/></svg>' },
            { id: 'boligrafo', name: 'el bolÃ­grafo', emoji: '<svg width="48" height="48"><svg xmlns="http://www.w3.org/2000/svg" width="412pt" height="412pt" viewBox="0 0 412 413"><path d="M393 340c-5-18-14-33-27-46L101 29c-4-4-11-4-15 0l-1 1L64 9a30 30 0 0 0-43 0L9 21a30 30 0 0 0 0 43l21 21-8 7a50 50 0 0 0 0 71l80 80a10 10 0 1 0 14-14l-80-80a30 30 0 0 1 0-41l119 119 22 22 14 14 103 103c13 13 28 22 46 27l60 19c3 1 7 0 10-2s3-7 2-10zM23 35l12-12a10 10 0 0 1 15 0l21 21-27 27-21-21c-4-4-4-11 0-15zm27 58 43-43 107 106-44 44zm120 121 44-44 21 21-44 44zm36 35 43-43 103 102 3 4-43 43-4-3zm139 125c-6-1-11-4-17-7l39-39 7 17 13 42zm0 0"/></svg>' },
            { id: 'cuaderno', name: 'el cuaderno', emoji: '<svg width="48" height="48"> <svg xmlns="http://www.w3.org/2000/svg"> <path fill-rule="evenodd" d="M95 58c-26 9-28 40 0 46v15c-26 9-28 40 0 46v15c-26 9-28 40 0 45v14c-26 9-28 41 0 46v15c-26 9-28 40 0 46v15c-26 9-28 40 0 46v15c-26 9-28 40 0 46v18c0 5 4 10 10 10h322c6 0 10-5 10-10V26c0-5-4-10-10-10H105c-6 0-10 5-10 10zm10 371v57h322l1-460H105v29l14-2c6-15 28-11 28 5s-22 20-28 5l-14 2v51l14-2c6-15 28-11 28 5s-22 20-28 5l-14 2v51l14-2c6-15 28-11 28 5s-22 20-28 5l-14 2v50l14-2c6-15 28-11 28 5s-22 19-28 5l-14 2v50l14-1c6-15 28-11 28 5s-22 19-28 5l-14 1v51l14-1c6-15 28-12 28 4s-22 20-28 5l-14 2v51l14-1c6-15 28-12 28 4s-22 20-28 5l-14 2zm-10 4c-13 5-15 21 0 25zm38-15c6 0 6 9 0 9s-6-9 0-9zm-38-46c-13 5-15 21 0 25zm38-15c6 0 6 9 0 9s-6-9 0-9zm-38-46c-13 6-15 21 0 25zm38-15c6 0 6 9 0 9s-6-9 0-9zm-38-46c-13 6-15 21 0 25zm38-15c6 0 6 9 0 9s-6-9 0-9zm-38-45c-13 6-15 22 0 25zm38-15c6 0 6 9 0 9s-6-9 0-9zm-38-46c-13 6-15 22 0 26zm38-15c6 1 6 10 0 10s-6-9 0-10zM95 68c-13 6-15 22 0 26zm38-14c6 0 6 9 0 9s-6-9 0-9z" clip-rule="evenodd"/> </svg>' },
            { id: 'tijeras', name: 'las tijeras', emoji: '<svg height="48" viewBox="0 0 43.35 43.35" width="48" xmlns="http://www.w3.org/2000/svg"><title>tijeras</title><g id="tijeras"><path id="tijeras" d="m21.95 21.71c-.16 0-.31.06-.43.18-.23.23-.23.62 0 .85.11.11.27.18.43.18.16 0 .31-.06.43-.18.24-.23.24-.62 0-.85h.00c-.12-.12-.27-.18-.43-.18zm0 1.97c-.36 0-.7-.14-.96-.4-.53-.53-.53-1.4 0-1.93.26-.26.6-.4.96-.4.37 0 .71.14.97.4.53.53.53 1.4 0 1.93-.26.25-.6.4-.97.4z"/><path id="borde_exterior_goma" d="m6.09 20.58c-1.42 0-2.76.55-3.77 1.56-1.01 1.01-1.56 2.35-1.56 3.77s.55 2.76 1.56 3.77c2.08 2.08 5.46 2.08 7.54 0s2.08-5.46 0-7.54c-1-1.01-2.34-1.56-3.77-1.56zm0 11.42c-1.56 0-3.12-.59-4.31-1.78-2.37-2.38-2.37-6.24 0-8.61s6.24-2.37 8.61 0c2.38 2.37 2.38 6.24 0 8.61-1.19 1.19-2.75 1.78-4.3 1.78z"/><path id="cuerpo_portaminas" d="m11.31 28.61c-.09 0-.19-.03-.26-.1-.15-.14-.16-.38 0-.54.33-.36.64-.7 1-1.04 1.44-1.61 2.59-2.88 4.08-3.39 1.58-.53 3.32-.11 5.64 1.36l17.46-10.31c3.09-2.53 3.46-4.16 3.43-4.84l-21.99 10.79c-.02.01-.05.02-.07.03-.65.16-1.34.36-2.07.58-2.85.83-6.08 1.78-8.63.91-.2-.07-.3-.28-.24-.48.07-.2.28-.3.48-.24 2.32.79 5.43-.12 8.17-.92.72-.21 1.41-.41 2.06-.58l22.38-10.98c.18-.09.4 0 .5.15.03.07.35.66 0 1.74-.41 1.35-1.62 2.84-3.59 4.45-.01.01-.03.02-.05.03l-17.68 10.44c-.13.08-.28.07-.4 0-4.63-3.03-6.16-1.33-8.94 1.76-.3.34-.61.69-.95 1.05-.08.08-.18.12-.28.12z"/><path id="borde_interior_goma" d="m6.09 22.94c-.76 0-1.52.29-2.1.87-.56.56-.87 1.3-.87 2.1s.31 1.54.87 2.1c1.16 1.15 3.04 1.15 4.2 0s1.15-3.04 0-4.2c-.58-.58-1.34-.87-2.1-.87zm0 6.69c-.96 0-1.91-.36-2.64-1.09-.7-.71-1.09-1.64-1.09-2.64s.39-1.93 1.09-2.63c1.45-1.46 3.82-1.46 5.27 0 1.46 1.45 1.46 3.82 0 5.27-.73.73-1.68 1.09-2.63 1.09z"/><path id="borde_exterior_punta" d="m17.72 31.93c-1.43 0-2.76.56-3.77 1.56-2.08 2.08-2.08 5.46 0 7.54s5.46 2.08 7.54 0c2.08-2.08 2.08-5.46 0-7.54-1.01-1-2.35-1.56-3.77-1.56zm0 11.42c-1.56 0-3.12-.59-4.31-1.78-2.37-2.38-2.37-6.24 0-8.61s6.24-2.37 8.61 0c2.38 2.37 2.38 6.24 0 8.61-1.18 1.19-2.75 1.78-4.3 1.78z"/><path id="clip_y_punta" d="m18.92 20.96c-.07 0-.13 0-.19-.05-.18-.11-.24-.34-.13-.52l9.8-16.6c0-.02.02-.03.03-.05 1.61-1.96 3.1-3.17 4.45-3.58 1.08-.34 1.68 0 1.74.01.18.1.24.32.15.5l-8.28 16.89c-.1.19-.32.27-.51.17-.19-.09-.27-.32-.17-.51l8.07-16.46c-.68 0-2.3.34-4.84 3.43l-9.79 16.58c-.07.12-.2.18-.33.18zm-3.52 11.46c-.1 0-.2-.04-.28-.12-.14-.15-.13-.4 0-.54.5-.46 1-.87 1.46-1.27 2.13-1.78 3.53-2.96 2.53-6.09-.07-.2.04-.42.24-.48.2-.06.42.05.48.25 1.16 3.62-.57 5.07-2.76 6.91-.47.39-.95.79-1.44 1.24-.07.07-.16.1-.25.1zm6.52 1.36c-.16 0-.3-.1-.36-.26-.83-2.43-.11-4.9.59-7.29.17-.58.34-1.18.49-1.76.05-.2.26-.33.46-.28.2.05.33.26.28.46-.15.59-.32 1.2-.5 1.79-.66 2.27-1.35 4.62-.6 6.83.07.2-.04.41-.24.48-.04.01-.08.02-.12.02z"/><path id="borde_interior_punta" d="m17.72 34.29c-.76 0-1.52.29-2.1.87-.56.56-.87 1.3-.87 2.1s.31 1.54.87 2.1c1.16 1.15 3.04 1.15 4.2 0 .56-.56.87-1.3.87-2.1s-.31-1.54-.87-2.1c-.58-.58-1.34-.87-2.1-.87zm0 6.69c-.95 0-1.91-.36-2.64-1.09-.7-.71-1.09-1.64-1.09-2.64s.38-1.93 1.09-2.63c1.45-1.46 3.82-1.46 5.27 0 .71.7.1.09 1.64.1.09 2.64s-.39 1.93-1.09 2.63c-.73.73-1.68 1.09-2.63 1.09z"/></g></svg>' },
            { id: 'borrador', name: 'el borrador', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="16" height="8" rx="2" fill="#4A5568"/><rect x="4" y="13" width="16" height="4" rx="1" fill="#E2E8F0"/><path d="M6 8H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/><path d="M6 10H18" stroke="#718096" stroke-width="1" stroke-linecap="round"/></svg>` },
            { id: 'sacapuntas', name: 'el sacapuntas', emoji: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 5H15C15.5523 5 16 5.44772 16 6V18C16 18.5523 15.5523 19 15 19H5C4.44772 19 4 18.5523 4 18V6C4 5.44772 4.44772 5 5 5Z" fill="#4A90E2"/><path d="M16 6L20 9V15L16 18V6Z" fill="#3A7BC8"/><circle cx="10" cy="8" r="3" fill="#FFFFFF"/><circle cx="10" cy="8" r="2" fill="#2D3748"/><rect x="5" y="14" width="10" height="2" rx="1" fill="#D1D5DB"/></svg>` },
            { id: 'goma', name: 'la goma de borrar', emoji: '<svg width="48" height="48" svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 297 297"><path d="M288 260H149l132-132c11-10 11-27 0-37l-64-65a27 27 0 0 0-38 0L12 193a27 27 0 0 0 0 37l30 30H9a9 9 0 0 0 0 19h279a9 9 0 0 0 0-19zM192 39c3-3 8-3 11 0l65 65a8 8 0 0 1 0 11L159 224l-76-76L192 39zm-69 221H68l-43-43c-3-3-3-8 0-11l45-45 76 76-23 23z"/></svg>' },
        ];

        const childrenNames = ["Ana", "Luis", "SofÃ­a", "Carlos", "Elena"];
        let childrenData = [];
        let timerInterval;
        let finalScore = 0;
        let percentageScore = 0;
        let gameFinished = false;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeActivity() {
            const objectBank = document.getElementById('objectBank');
            const childrenContainer = document.getElementById('childrenContainer');
            
            const usableVocabulary = vocabulary;
            
            usableVocabulary.forEach(item => {
                const div = document.createElement('div');
                div.id = `item-${item.id}`;
                div.dataset.itemId = item.id;
                div.title = item.name;
                div.className = 'item-utiles w-16 h-16 p-1 bg-gray-100 rounded-lg flex items-center justify-center cursor-grab';
                div.draggable = true;
                div.innerHTML = `<div class="text-4xl select-none flex items-center justify-center">${item.emoji}</div>`;
                div.addEventListener('dragstart', onDragStart);
                div.addEventListener('dragend', onDragEnd);
                objectBank.appendChild(div);
            });

            childrenNames.forEach(name => {
                const shuffledVocab = shuffleArray([...usableVocabulary]);
                const missingItemsCount = Math.floor(Math.random() * 4) + 3;
                const missingItems = shuffledVocab.slice(0, missingItemsCount);
                
                childrenData.push({ name: name, required: missingItems.map(item => item.id), found: [] });

                const childCard = document.createElement('div');
                childCard.className = 'bg-white p-6 rounded-2xl shadow-md';
                
                let listItemsHTML = '';
                missingItems.forEach(item => {
                    listItemsHTML += `<li id="req-${name}-${item.id}" class="text-gray-700 transition-colors">${item.name}</li>`;
                });

                childCard.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">Mochila de ${name}</h3>
                    <p class="font-semibold mb-2 text-gray-500">Faltan estos Ãºtiles / Missing items:</p>
                    <ul class="list-disc list-inside mb-4 space-y-1">${listItemsHTML}</ul>
                    <div id="dropzone-${name}" data-child-name="${name}" class="drop-zone min-h-[150px] p-4 rounded-lg bg-gray-50 grid grid-cols-3 gap-2 items-start content-start relative">
                         <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl text-gray-300 opacity-50 select-none pointer-events-none">ðŸŽ’</div>
                    </div>
                `;
                childrenContainer.appendChild(childCard);
            });
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', onDragOver);
                zone.addEventListener('dragleave', onDragLeave);
                zone.addEventListener('drop', onDrop);
            });
            
            startTimer(300);
        }
        
        function startTimer(durationInSeconds) {
            let timer = durationInSeconds;
            const countdownEl = document.getElementById('countdown');
            const timerContainer = document.getElementById('timer-container');

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                let seconds = timer % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                countdownEl.textContent = `${minutes}:${seconds}`;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    countdownEl.textContent = "00:00";
                    checkAnswers();
                } else if (timer < 59) {
                    timerContainer.classList.remove('bg-yellow-100', 'border-yellow-300', 'text-yellow-800');
                    timerContainer.classList.add('bg-orange-100', 'border-orange-300', 'text-orange-800');
                }
            }, 1000);
        }

        function onDragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.id);
            setTimeout(() => event.target.classList.add('dragging'), 0);
        }
        
        function onDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            const itemId = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(itemId);
            const dropZone = event.currentTarget;
            const childName = dropZone.dataset.childName;
            
            dropZone.classList.remove('drag-over');
            
            const child = childrenData.find(c => c.name === childName);
            const droppedItemId = draggedElement.dataset.itemId;

            if (child.required.includes(droppedItemId) && !child.found.includes(droppedItemId)) {
                const clonedElement = draggedElement.cloneNode(true);
                clonedElement.id = `clone-${childName}-${droppedItemId}`;
                clonedElement.draggable = false;
                clonedElement.style.cursor = 'default';
                clonedElement.classList.remove('item-utiles', 'cursor-grab');
                clonedElement.title = '';
                
                dropZone.appendChild(clonedElement);
                child.found.push(droppedItemId);
                document.getElementById(`req-${childName}-${droppedItemId}`).classList.add('correct-item');
            }
        }

        function checkAnswers() {
            if (gameFinished) return;
            gameFinished = true;
            clearInterval(timerInterval);

            let correctItemsCount = 0;
            let totalRequiredItems = 0;
            childrenData.forEach(child => {
                correctItemsCount += child.found.length;
                totalRequiredItems += child.required.length;
            });

            finalScore = correctItemsCount * 10;
            percentageScore = totalRequiredItems > 0 ? Math.round((correctItemsCount / totalRequiredItems) * 100) : 0;
            const emoji = percentageScore >= 70 ? 'ðŸ˜Š' : 'ðŸ˜Ÿ';

            const feedbackEl = document.getElementById('feedback');
            feedbackEl.classList.remove('opacity-0');
            feedbackEl.style.opacity = 1;
            
            feedbackEl.innerHTML = `<strong>ES:</strong> Â¡Juego terminado!<br><strong>Puntaje: ${finalScore}</strong> (${percentageScore}% de aciertos) ${emoji}<br><br><strong>EN:</strong> Game Over!<br><strong>Score: ${finalScore}</strong> (${percentageScore}% correct) ${emoji}`;
            
            const timerContainer = document.getElementById('timer-container');
            if (percentageScore >= 70) {
                 feedbackEl.classList.add('text-green-600');
                 timerContainer.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
            } else {
                 feedbackEl.classList.add('text-red-600');
                 timerContainer.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
            }
            document.querySelector('#timer-container h2:first-of-type').textContent = "Â¡Tiempo finalizado!";
            document.querySelector('#timer-container h2:last-of-type').textContent = "Time's up!";
            
            document.getElementById('send-score-form').classList.add('visible');
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('objectBank').style.pointerEvents = 'none';
            document.getElementById('objectBank').style.opacity = '0.5';
        }

        function sendScoreToGoogleSheet() {
            const studentName = document.getElementById('studentName').value;
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyWKOmqCWN4H_c42I4DnaO2wrjvpjZbgifu41bfyk4UdDvXJpsF1H1DjnQ3tAV2WhWXnQ/exec';
            const sendStatus = document.getElementById('send-status');
            const sendBtn = document.getElementById('sendBtn');

            if (!studentName) {
                alert("Por favor, ingresa tu nombre. / Please enter your name.");
                return;
            }

            sendStatus.textContent = "Enviando... / Sending...";
            sendBtn.disabled = true;

            const formData = new FormData();
            formData.append('name', studentName);
            formData.append('score', finalScore);
            formData.append('percentage', percentageScore);
            
            // We use 'no-cors' mode as a simple way to submit data to a Google Script
            // from a static HTML file without a complex server setup. The browser
            // sends the data but can't read the response, preventing a CORS error.
            // The .catch block often triggers even on success due to an opaque redirect,
            // so we can treat it as a confirmation that the data was sent.
            fetch(scriptURL, { method: 'POST', body: formData, mode: 'no-cors'})
            .then(() => {
                sendStatus.textContent = "Â¡Resultado guardado con Ã©xito! / Result saved successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
            })
            .catch(error => {
                // This is expected behavior with 'no-cors' mode and Google Scripts.
                // We show a success message as the data has been sent.
                sendStatus.textContent = "Â¡Resultado enviado con Ã©xito! / Result sent successfully!";
                sendStatus.style.color = 'green';
                sendBtn.style.backgroundColor = '#4a5568';
                console.log('Request sent. This is the expected outcome with no-cors mode.', error);
            });
        }

        document.addEventListener('DOMContentLoaded', initializeActivity);
    </script>
</body>
</html>

